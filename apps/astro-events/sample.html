<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Trực Quan Sự Kiện Astro-Gann</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- ApexCharts for the timeline visualization -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        /* FIX: Switched to a light theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; } /* slate-200 */
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; } /* slate-300 */
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; } /* slate-400 */
        
        /* Updated panel style for light theme */
        .glass-panel {
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loader-spin {
            animation: spin 1.5s linear infinite;
        }
        
        /* FIX: Updated tooltip for light theme */
        .apexcharts-tooltip {
            background: #ffffff !important;
            color: #1e293b !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .apexcharts-tooltip .apexcharts-tooltip-title {
            background: #f1f5f9 !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-t-purple-500 border-gray-300 rounded-full loader-spin"></div>
        <p class="mt-4 text-lg text-gray-600">Đang khởi tạo Công cụ Thiên thể...</p>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="max-w-7xl mx-auto p-4 lg:p-8 opacity-0 transition-opacity duration-500">
        
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-cyan-500">Trình Trực Quan Astro-Gann</h1>
            <p class="text-slate-500 mt-2">Theo dõi các chu kỳ hành tinh và các sự kiện thiên thể quan trọng.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <main class="w-full lg:w-2/3">
                <div class="glass-panel p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-slate-900 mb-4 sm:mb-0">Tổng Quan Sự Kiện</h2>
                        <div class="relative">
                            <label for="date-picker" class="text-slate-600 mr-2">Chọn Ngày:</label>
                            <input type="date" id="date-picker" class="bg-slate-50 border border-slate-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div id="timeline-chart" class="mb-8"></div>

                    <h3 class="text-xl font-semibold text-slate-900 mb-4 border-t border-slate-200 pt-6">Chi Tiết Dòng Thời Gian</h3>
                    <div id="timeline" class="space-y-6 max-h-[45vh] overflow-y-auto pr-4">
                        <!-- Event items will be dynamically inserted here -->
                    </div>
                </div>
            </main>

            <aside class="w-full lg:w-1/3">
                <div class="glass-panel p-6 sticky top-8">
                    <h2 class="text-2xl font-semibold text-slate-900 mb-6">Sự Kiện Sắp Tới</h2>
                    <div id="upcoming-events" class="space-y-4 mb-8">
                        <!-- Upcoming event snippets will be dynamically inserted here -->
                    </div>

                    <h2 class="text-2xl font-semibold text-slate-900 mb-4 border-t border-slate-200 pt-6">Tìm Sự Kiện</h2>
                    <div id="event-finder" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- Event finder buttons will be dynamically inserted here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script type="module">
        // =================================================================
        // ASTRO-GANN EVENT VISUALIZER - JAVASCRIPT LOGIC (VIETNAMESE)
        // =================================================================

        const AstroCalculator = {
            isInitialized: false,
            async init() {
                await new Promise(resolve => setTimeout(resolve, 1500));
                this.isInitialized = true;
                return true;
            },
            
            getEventsForDateRange(startDate, endDate) {
                if (!this.isInitialized) throw new Error("AstroCalculator not initialized.");
                
                let events = [];
                const startYear = startDate.getFullYear();
                const endYear = endDate.getFullYear();

                const pseudoRandom = (seed) => {
                    let h = 1779033703 ^ seed;
                    h = Math.imul(h ^ (h >>> 16), 2246822507);
                    h = Math.imul(h ^ (h >>> 13), 3266489909);
                    return (h ^= h >>> 16) >>> 0;
                };

                for (let year = startYear; year <= endYear; year++) {
                    events.push({ startDate: `${year}-03-20T09:02:00Z`, endDate: `${year}-03-22T09:02:00Z`, type: 'season', title: "Xuân Phân", description: "Mặt Trời đi vào Bạch Dương." });
                    events.push({ startDate: `${year}-06-21T02:42:00Z`, endDate: `${year}-06-23T02:42:00Z`, type: 'season', title: "Hạ Chí", description: "Ngày dài nhất trong năm." });
                    events.push({ startDate: `${year}-09-22T18:19:00Z`, endDate: `${year}-09-24T18:19:00Z`, type: 'season', title: "Thu Phân", description: "Điểm cân bằng, thường liên quan đến biến động." });
                    events.push({ startDate: `${year}-12-21T14:03:00Z`, endDate: `${year}-12-23T14:03:00Z`, type: 'season', title: "Đông Chí", description: "Ngày ngắn nhất trong năm." });
                    events.push({ startDate: `${year}-02-03T00:00:00Z`, endDate: `${year}-02-05T00:00:00Z`, type: 'minor-season', title: "Ngày Giao Mùa Phụ", description: "Điểm giữa Đông Chí và Xuân Phân." });
                    events.push({ startDate: `${year}-05-05T00:00:00Z`, endDate: `${year}-05-07T00:00:00Z`, type: 'minor-season', title: "Ngày Giao Mùa Phụ", description: "Điểm giữa Xuân Phân và Hạ Chí." });
                    events.push({ startDate: `${year}-08-07T00:00:00Z`, endDate: `${year}-08-09T00:00:00Z`, type: 'minor-season', title: "Ngày Giao Mùa Phụ", description: "Điểm giữa Hạ Chí và Thu Phân." });
                    events.push({ startDate: `${year}-11-07T00:00:00Z`, endDate: `${year}-11-09T00:00:00Z`, type: 'minor-season', title: "Ngày Giao Mùa Phụ", description: "Điểm giữa Thu Phân và Đông Chí." });
                    events.push({ startDate: `${year}-03-15T00:00:00Z`, endDate: `${year}-04-07T00:00:00Z`, type: 'retrograde', title: "Sao Thủy Nghịch Hành", description: `Sao Thủy nghịch hành.` });
                    events.push({ startDate: `${year}-07-18T00:00:00Z`, endDate: `${year}-08-11T00:00:00Z`, type: 'retrograde', title: "Sao Thủy Nghịch Hành", description: `Sao Thủy nghịch hành.` });
                    events.push({ startDate: `${year}-11-09T00:00:00Z`, endDate: `${year}-11-29T00:00:00Z`, type: 'retrograde', title: "Sao Thủy Nghịch Hành", description: `Sao Thủy nghịch hành.` });
                    if(year % 2 === 0) events.push({ startDate: `${year}-12-06T00:00:00Z`, endDate: `${year+1}-02-24T00:00:00Z`, type: 'retrograde', title: "Hỏa Tinh Nghịch Hành", description: "Giai đoạn Sao Hỏa đi lùi." });
                    events.push({ startDate: `${year}-10-09T00:00:00Z`, endDate: `${year+1}-02-04T00:00:00Z`, type: 'retrograde', title: "Mộc Tinh Nghịch Hành", description: "Giai đoạn Sao Mộc đi lùi." });
                    events.push({ startDate: `${year}-05-02T00:00:00Z`, endDate: `${year}-10-11T00:00:00Z`, type: 'retrograde', title: "Hải Vương Tinh Nghịch Hành", description: "Giai đoạn Sao Hải Vương đi lùi." });
                    if (year % 4 === 1) events.push({ startDate: `${year}-06-09T00:00:00Z`, endDate: `${year}-06-11T00:00:00Z`, type: 'ingress', title: "Mộc Tinh nhập cung Khí", description: "Sao Mộc vào cung Khí." });
                    if (year % 7 === 4 ) events.push({ startDate: `${year}-05-25T00:00:00Z`, endDate: `${year}-05-27T00:00:00Z`, type: 'ingress', title: "Thổ Tinh nhập cung Đất", description: "Sao Thổ vào cung Đất." });
                    if (year % 3 === 2 ) events.push({ startDate: `${year}-11-05T00:00:00Z`, endDate: `${year}-11-07T00:00:00Z`, type: 'ingress', title: "Kim Tinh nhập cung Đất", description: "Sao Kim vào cung Đất." });
                    events.push({ startDate: `${year}-08-20T00:00:00Z`, endDate: `${year}-08-22T00:00:00Z`, type: 'latitude', title: "Kim Tinh vĩ độ cực hạn", description: "Kim tinh đạt vĩ độ xa nhất." });
                    events.push({ startDate: `${year}-09-05T00:00:00Z`, endDate: `${year}-09-07T00:00:00Z`, type: 'speed-threshold', title: "Tốc độ Thủy Tinh 0.59", description: "Tốc độ của Sao Thủy đạt ngưỡng quan trọng." });
                    events.push({ startDate: `${year}-07-06T00:00:00Z`, endDate: `${year}-07-08T00:00:00Z`, type: 'fixed-degree', title: "Hỏa Tinh ở 15° Cự Giải", description: "Sao Hỏa đi qua điểm nhạy cảm." });

                    for (let month = 0; month < 12; month++) {
                        const monthSeed = year * 100 + month;
                        const newMoonDay = 1 + (pseudoRandom(monthSeed + 1) % 10); 
                        let date = new Date(year, month, newMoonDay);
                        events.push({ startDate: date.toISOString(), endDate: new Date(date.getTime() + 48 * 3600 * 1000).toISOString(), type: 'new-moon', title: "Trăng Non", description: "Thời điểm cho sự khởi đầu mới." });
                        
                        const fullMoonDay = 15 + (pseudoRandom(monthSeed + 2) % 10);
                        date = new Date(year, month, fullMoonDay);
                        events.push({ startDate: date.toISOString(), endDate: new Date(date.getTime() + 48 * 3600 * 1000).toISOString(), type: 'full-moon', title: "Trăng Tròn", description: "Gắn liền với cảm xúc đỉnh cao." });
                        
                         if(month % 4 === 0) { 
                            const cazimiDay = 10 + (pseudoRandom(monthSeed + 7) % 15);
                            date = new Date(year, month, cazimiDay);
                            events.push({ startDate: date.toISOString(), endDate: new Date(date.getTime() + 24 * 3600 * 1000).toISOString(), type: 'cazimi', title: "Kim Tinh Giao Hội Mặt Trời", description: "Điểm giao hội chính xác." });
                         }
                    }
                }
                
                const filteredEvents = events.filter(event => new Date(event.startDate) <= endDate && new Date(event.endDate) >= startDate);
                
                const uniqueEvents = filteredEvents.filter((event, index, self) =>
                    index === self.findIndex((t) => (t.title === event.title && new Date(t.startDate).getFullYear() === new Date(event.startDate).getFullYear() ))
                );

                return uniqueEvents.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            },

            getAllKnownEventDefinitions() {
                return [
                    { title: "Sao Thủy Nghịch Hành", type: "retrograde" },
                    { title: "Hỏa Tinh Nghịch Hành", type: "retrograde" },
                    { title: "Mộc Tinh Nghịch Hành", type: "retrograde" },
                    { title: "Hải Vương Tinh Nghịch Hành", type: "retrograde" },
                    { title: "Xuân Phân", type: "season" },
                    { title: "Hạ Chí", type: "season" },
                    { title: "Thu Phân", type: "season" },
                    { title: "Đông Chí", type: "season" },
                    { title: "Ngày Giao Mùa Phụ", type: "minor-season" },
                    { title: "Mộc Tinh nhập cung Khí", type: "ingress" },
                    { title: "Thổ Tinh nhập cung Đất", type: "ingress" },
                    { title: "Kim Tinh nhập cung Đất", type: "ingress" },
                    { title: "Trăng Non", type: "new-moon" },
                    { title: "Trăng Tròn", type: "full-moon" },
                    { title: "Thổ Tinh trùng tụ với Mộc Tinh", type: "conjunction"},
                    { title: "Kim Tinh Giao Hội Mặt Trời", type: "cazimi"},
                    { title: "Hỏa Tinh ở 15° Cự Giải", type: "fixed-degree"},
                    { title: "Kim Tinh vĩ độ cực hạn", type: "latitude"},
                    { title: "Tốc độ Thủy Tinh 0.59", type: "speed-threshold"}
                ];
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContainer = document.getElementById('app');
            const datePicker = document.getElementById('date-picker');
            const timelineContainer = document.getElementById('timeline');
            const upcomingContainer = document.getElementById('upcoming-events');
            const chartContainer = document.getElementById('timeline-chart');
            const eventFinderContainer = document.getElementById('event-finder');
            let timelineChart = null;
            let focusDate = new Date();
            let isChartEventTriggered = false; 

            await AstroCalculator.init();
            loadingOverlay.style.opacity = '0';
            appContainer.style.opacity = '1';
            setTimeout(() => loadingOverlay.style.display = 'none', 500);
            
            lucide.createIcons();
            
            const handleEventClick = (event) => {
                const dateString = event.currentTarget.dataset.startDate;
                if (!dateString) return;
                focusDate = new Date(dateString);
                setDatePicker(focusDate);
                updateDisplay();
            };
            
            const findNextEvent = (title) => {
                const now = new Date();
                const searchLimit = new Date();
                searchLimit.setFullYear(now.getFullYear() + 40);

                let allFutureEvents = AstroCalculator.getEventsForDateRange(now, searchLimit);
                const nextEvent = allFutureEvents.find(e => e.title === title && new Date(e.startDate) > now);

                if (nextEvent) {
                    focusDate = new Date(nextEvent.startDate);
                    setDatePicker(focusDate);
                    updateDisplay();
                } else {
                    alert(`Không tìm thấy sự kiện "${title}" trong 40 năm tới.`);
                }
            };

            function renderTimelineChart(events) {
                const seriesData = {};
                const eventColors = {};
                
                events.forEach(event => {
                    const visuals = getEventVisuals(event.type);
                    if (!seriesData[event.type]) {
                        seriesData[event.type] = [];
                        eventColors[event.type] = visuals.color;
                    }
                    seriesData[event.type].push({
                        x: event.title,
                        y: [
                            new Date(event.startDate).getTime(),
                            new Date(event.endDate).getTime()
                        ],
                        description: event.description
                    });
                });

                const series = Object.keys(seriesData).map(type => ({
                    name: type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    data: seriesData[type]
                }));
                
                const colors = Object.values(eventColors);

                const options = {
                    series: series,
                    chart: {
                        height: 350,
                        type: 'rangeBar',
                        background: 'transparent',
                        toolbar: { show: false },
                        zoom: { enabled: true, type: 'x', autoScaleYaxis: true },
                        events: {
                            zoomed: (chartContext, { xaxis }) => {
                                isChartEventTriggered = true;
                                const newCenterTimestamp = (xaxis.min + xaxis.max) / 2;
                                focusDate = new Date(newCenterTimestamp);
                                setDatePicker(focusDate);
                                updateDisplay();
                                setTimeout(() => { isChartEventTriggered = false; }, 100);
                            }
                        }
                    },
                    plotOptions: { bar: { horizontal: true, barHeight: '50%', rangeBarGroupRows: true } },
                    colors: colors,
                    fill: { type: 'solid', opacity: 0.6 },
                    xaxis: { type: 'datetime', labels: { style: { colors: '#475569' } }, axisBorder: { show: false }, axisTicks: { color: '#cbd5e1' } },
                    yaxis: { labels: { style: { colors: '#475569' } } },
                    legend: { show: false },
                    grid: { borderColor: '#e2e8f0', },
                    tooltip: { theme: 'light' }
                };

                if (timelineChart) {
                    timelineChart.updateOptions(options, false, false); 
                } else {
                    timelineChart = new ApexCharts(chartContainer, options);
                    timelineChart.render();
                }
            }

            function renderTimelineList(events, centerDate) {
                timelineContainer.innerHTML = '';
                if (events.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-slate-500 text-center py-8">Không có sự kiện quan trọng nào trong giai đoạn này.</p>`;
                    return;
                }
                events.forEach(event => {
                    const eventDate = new Date(event.startDate);
                    const isPast = eventDate < centerDate;
                    const { icon, color } = getEventVisuals(event.type);
                    
                    const eventElement = document.createElement('div');
                    eventElement.className = `flex items-start gap-4 p-4 rounded-lg border-l-4 transition-colors duration-200 cursor-pointer hover:bg-slate-100 ${isPast ? 'opacity-60' : ''}`;
                    eventElement.style.borderColor = color;
                    eventElement.dataset.startDate = event.startDate;
                    
                    eventElement.innerHTML = `<div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background-color: ${color}20;"><i data-lucide="${icon}" class="w-6 h-6" style="color: ${color};"></i></div><div class="flex-grow"><p class="font-semibold text-slate-800">${event.title}</p><p class="text-sm text-slate-600">${event.description}</p><p class="text-xs text-slate-500 mt-2">${formatEventDate(eventDate)}</p></div>`;
                    timelineContainer.appendChild(eventElement);
                    eventElement.addEventListener('click', handleEventClick);
                });
                lucide.createIcons();
            }

            function renderUpcomingEvents(centerDate) {
                upcomingContainer.innerHTML = '';
                const now = new Date();
                const sixMonthsFromNow = new Date();
                sixMonthsFromNow.setMonth(now.getMonth() + 6);
                
                const allFutureEvents = AstroCalculator.getEventsForDateRange(now, sixMonthsFromNow);
                
                const futureEvents = allFutureEvents.filter(e => new Date(e.startDate) > now);

                if (futureEvents.length === 0) {
                    upcomingContainer.innerHTML = `<p class="text-slate-500 text-sm">Không có sự kiện lớn nào trong 6 tháng tới.</p>`;
                    return;
                }
                futureEvents.slice(0, 5).forEach(event => {
                    const eventDate = new Date(event.startDate);
                    const { icon, color } = getEventVisuals(event.type);
                    
                    const eventElement = document.createElement('div');
                    eventElement.className = 'flex items-center gap-3 p-2 rounded-md transition-colors duration-200 cursor-pointer hover:bg-slate-100';
                    eventElement.dataset.startDate = event.startDate;

                    eventElement.innerHTML = `<div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center" style="background-color: ${color}20;"><i data-lucide="${icon}" class="w-4 h-4" style="color: ${color};"></i></div><div><p class="font-medium text-sm text-slate-800">${event.title}</p><p class="text-xs text-slate-500">${formatEventDate(eventDate)}</p></div>`;
                    upcomingContainer.appendChild(eventElement);
                    eventElement.addEventListener('click', handleEventClick);
                });
                lucide.createIcons();
            }

            function renderEventFinder() {
                eventFinderContainer.innerHTML = '';
                const eventDefs = AstroCalculator.getAllKnownEventDefinitions();
                eventDefs.forEach(def => {
                    const { icon, color } = getEventVisuals(def.type);
                    const button = document.createElement('button');
                    button.className = 'w-full flex items-center gap-3 p-2 rounded-md text-left transition-colors duration-200 hover:bg-slate-100';
                    button.innerHTML = `<div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center" style="background-color: ${color}20;"><i data-lucide="${icon}" class="w-4 h-4" style="color: ${color};"></i></div><span class="text-sm text-slate-700">${def.title}</span>`;
                    button.onclick = () => findNextEvent(def.title);
                    eventFinderContainer.appendChild(button);
                });
                lucide.createIcons();
            }
            
            function getEventVisuals(type) {
                const visuals = {
                    'season': { icon: 'sun', color: '#f59e0b' }, 
                    'minor-season': { icon: 'leaf', color: '#10b981' }, 
                    'new-moon': { icon: 'moon', color: '#3b82f6' }, 
                    'full-moon': { icon: 'circle', color: '#a855f7' },
                    'retrograde': { icon: 'arrow-left-right', color: '#ef4444' },
                    'conjunction': { icon: 'link-2', color: '#8b5cf6' },
                    'ingress': { icon: 'log-in', color: '#d97706' },
                    'aspect': { icon: 'star', color: '#14b8a6' }, 
                    'cazimi': { icon: 'sun', color: '#f59e0b' },
                    'fixed-degree': { icon: 'map-pin', color: '#8b5cf6' },
                    'latitude': { icon: 'globe-2', color: '#0ea5e9' },
                    'speed-threshold': { icon: 'gauge-circle', color: '#f97316' },
                    'default': { icon: 'sparkles', color: '#64748b' }
                };
                return visuals[type] || visuals['default'];
            }

            function formatEventDate(date) {
                return date.toLocaleString('vi-VN', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Ho_Chi_Minh'
                });
            }
            
            function setDatePicker(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                datePicker.value = `${year}-${month}-${day}`;
            }

            function updateDisplay() {
                const startDate = new Date(focusDate);
                startDate.setDate(startDate.getDate() - 60); 
                const endDate = new Date(focusDate);
                endDate.setDate(endDate.getDate() + 60);
                const events = AstroCalculator.getEventsForDateRange(startDate, endDate);
                
                renderTimelineChart(events);
                renderTimelineList(events, focusDate);
                renderUpcomingEvents(focusDate);
            }
            
            datePicker.addEventListener('change', () => {
                if(isChartEventTriggered) return;
                const [year, month, day] = datePicker.value.split('-').map(Number);
                focusDate = new Date(year, month - 1, day);
                updateDisplay();
            });

            // Initial Load
            setDatePicker(focusDate);
            renderEventFinder();
            updateDisplay();
        });
    </script>
</body>
</html>
