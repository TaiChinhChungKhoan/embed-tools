import React, { useState, useMemo } from 'react';

// --- ICONS (as SVG components for self-containment) ---
const BookOpen = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>);
const CheckCircle = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>);
const Search = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>);
const TrendingUp = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>);
const Shield = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>);
const ClipboardList = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>);


// --- ILLUSTRATION COMPONENTS ---
const BarChart = ({ high = 5, low = 95, close = 70, color = "currentColor" }) => (
    <svg viewBox="0 0 20 100" width="25" height="100" className="mx-auto">
        <line x1="10" y1={high} x2="10" y2={low} stroke={color} strokeWidth="2.5" />
        <line x1="10" y1={close} x2="18" y2={close} stroke={color} strokeWidth="2.5" />
    </svg>
);

const VolumeBar = ({ height = 60, color = "currentColor"}) => (
     <div className="flex items-end justify-center h-20">
        <div style={{ height: `${height}%`, backgroundColor: color }} className="w-6 rounded-t-sm"></div>
    </div>
);


// --- DATA STORE ---
const learningPath = [
    {
        id: 'fundamentals',
        title: 'Nền tảng VSA: Đọc hiểu từng thanh Bar',
        description: 'Trước khi phân tích các mẫu hình phức tạp, hãy nắm vững 3 yếu tố cốt lõi của một thanh giá.',
        concepts: [
            { id: 'spread', title: 'Biên Độ Giá (Spread)', content: 'Phản ánh sức mạnh tương quan giữa hai bên Mua và Bán. Spread rộng cho thấy một bên chiếm ưu thế. Spread hẹp cho thấy sự cân bằng hoặc do dự.', illustration: (<div className="flex justify-around items-center h-full"><div><BarChart high={5} low={95} close={20} color="#34d399" /><p className="text-xs text-center mt-1">Rộng</p></div><div><BarChart high={35} low={65} close={45} color="#f87171" /><p className="text-xs text-center mt-1">Hẹp</p></div></div>) },
            { id: 'close', title: 'Giá Đóng Cửa', content: 'Vị trí đóng cửa cho thấy phe nào thắng thế cuối phiên. Đóng cửa cao = phe mua thắng. Đóng cửa thấp = phe bán thắng.', illustration: (<div className="flex justify-around items-center h-full"><div><BarChart high={10} low={90} close={20} color="#34d399" /><p className="text-xs text-center mt-1">Cao</p></div><div><BarChart high={10} low={90} close={80} color="#f87171" /><p className="text-xs text-center mt-1">Thấp</p></div><div><BarChart high={10} low={90} close={50} color="#9ca3af" /><p className="text-xs text-center mt-1">Giữa</p></div></div>) },
            { id: 'volume', title: 'Khối Lượng (Volume)', content: 'Là thước đo năng lượng. Volume lớn xác nhận sức mạnh. Volume thấp cho thấy sự cạn kiệt hoặc thiếu quan tâm.', illustration: (<div className="flex justify-around items-end h-full pt-5"><div><VolumeBar height={20} color="#9ca3af" /><p className="text-xs text-center mt-1">Thấp</p></div><div><VolumeBar height={50} color="#60a5fa" /><p className="text-xs text-center mt-1">Trung bình</p></div><div><VolumeBar height={90} color="#f87171" /><p className="text-xs text-center mt-1">Cao</p></div></div>) },
            { id: 'context', title: 'Bối Cảnh: Vùng Cung - Cầu', content: 'Vùng Cầu (hỗ trợ) là nơi lực mua tiềm năng xuất hiện. Vùng Cung (kháng cự) là nơi lực bán tiềm năng xuất hiện.', illustration: (<div className="h-full w-full flex flex-col justify-center px-2"><div className="w-full bg-red-500/10 border-t-2 border-b-2 border-dashed border-red-400 py-1 mb-10"><p className="text-xs text-center text-red-300 font-semibold">Vùng Cung</p></div><div className="w-full h-1 bg-gray-700"></div><div className="w-full bg-emerald-500/10 border-t-2 border-b-2 border-dashed border-emerald-400 py-1 mt-10"><p className="text-xs text-center text-emerald-300 font-semibold">Vùng Cầu</p></div></div>) },
        ]
    },
];

const absorptionPairsByZone = [
    {
        zone: 'Tại Vùng Cung (Kháng cự)',
        description: 'So sánh các tín hiệu đối lập khi giá tiếp cận vùng có áp lực bán mạnh.',
        pairs: [
            {
                supply: { title: 'Upbar hấp thụ cung', analysis: { spread: 'Rộng/Trung bình.', volume: 'Lớn.', close: 'Đóng cửa gần Cao.'}, result: 'Tiềm năng TĂNG, vượt đỉnh.' },
                demand: { title: 'Upbar hấp thụ cầu', analysis: { spread: 'Hẹp.', volume: 'Lớn.', close: 'Đóng cửa gần Thấp.'}, result: 'Tiềm năng GIẢM, tạo đỉnh.' }
            },
            {
                supply: { title: 'Breakout dứt khoát', analysis: { spread: 'Rộng.', volume: 'Cực Lớn.', close: 'Vượt vùng cung, đóng cửa cao.'}, result: 'Xác nhận sức mạnh, TĂNG tiếp diễn.' },
                demand: { title: 'Buying Climax (Cao trào mua)', analysis: { spread: 'Rộng nhưng không giữ được giá.', volume: 'Cực Lớn.', close: 'Đóng cửa nửa dưới thân bar.'}, result: 'Bẫy tăng giá, khả năng GIẢM mạnh.' }
            },
            {
                supply: { title: 'No Supply gần vùng cung', analysis: { spread: 'Hẹp.', volume: 'Thấp.', close: 'Đóng cửa giữa/thấp (downbar).'}, result: 'Tạm nghỉ để TĂNG tiếp.' },
                demand: { title: 'No Demand tại vùng cung', analysis: { spread: 'Hẹp.', volume: 'Thấp.', close: 'Đóng cửa giữa (upbar).'}, result: 'Cầu cạn kiệt, tiềm năng GIẢM.' }
            },
            {
                supply: { title: 'Shakeout dưới vùng cung', analysis: { spread: 'Rộng.', volume: 'Lớn.', close: 'Hồi phục đóng cửa cao.'}, result: 'Loại bỏ phe yếu, chuẩn bị TĂNG.' },
                demand: { title: 'Upthrust', analysis: { spread: 'Rộng.', volume: 'Lớn.', close: 'Bị bán ngược, đóng cửa thấp.'}, result: 'Tín hiệu bán rất mạnh, GIẢM.' }
            },
        ]
    },
    {
        zone: 'Tại Vùng Cầu (Hỗ trợ)',
        description: 'So sánh các tín hiệu đối lập khi giá tiếp cận vùng có lực mua tiềm năng.',
        pairs: [
            {
                supply: { title: 'Downbar hấp thụ cung', analysis: { spread: 'Hẹp.', volume: 'Lớn.', close: 'Đóng cửa gần Cao.'}, result: 'Lực bán bị hấp thụ, tiềm năng TĂNG.' },
                demand: { title: 'Downbar tiếp diễn', analysis: { spread: 'Rộng/Trung bình.', volume: 'Lớn.', close: 'Đóng cửa gần Thấp.'}, result: 'Hỗ trợ yếu, tiềm năng GIẢM tiếp.' }
            },
            {
                supply: { title: 'Selling Climax (Cao trào bán)', analysis: { spread: 'Rộng.', volume: 'Cực Lớn.', close: 'Phục hồi, đóng cửa ở nửa trên.'}, result: 'Tạo đáy, khả năng TĂNG mạnh.' },
                demand: { title: 'Breakdown dứt khoát', analysis: { spread: 'Rộng.', volume: 'Cực Lớn.', close: 'Vượt vùng cầu, đóng cửa thấp.'}, result: 'Xác nhận xu hướng GIẢM.' }
            },
            {
                supply: { title: 'No Supply tại vùng cầu', analysis: { spread: 'Hẹp.', volume: 'Thấp.', close: 'Đóng cửa giữa/thấp (downbar).'}, result: 'Tín hiệu mua sớm, chờ TĂNG.' },
                demand: { title: 'No Demand tại vùng cầu', analysis: { spread: 'Hẹp.', volume: 'Thấp.', close: 'Đóng cửa giữa (upbar).'}, result: 'Cầu yếu, có thể GIẢM tiếp.' }
            },
            {
                supply: { title: 'Shakeout', analysis: { spread: 'Rộng.', volume: 'Lớn.', close: 'Hồi phục đóng cửa cao.'}, result: 'Tín hiệu mua rất mạnh, TĂNG.' },
                demand: { title: 'Hồi phục yếu ớt bị bán', analysis: { spread: 'Upbar yếu bị theo sau bởi Downbar mạnh.', volume: 'Tăng ở Downbar.', close: 'Downbar đóng cửa thấp.'}, result: 'Bán chủ động, phe mua yếu, GIẢM.'}
            },
             {
                supply: { title: 'Stopping Volume', analysis: { spread: 'Có thể rộng hoặc hẹp.', volume: 'Cực lớn (cao đột biến).', close: 'Được đẩy lên khỏi mức đáy.'}, result: 'Tạm dừng giảm, chờ xác nhận TĂNG.' },
                demand: null
            },
        ]
    }
];

const specialPatterns = [
    {
        title: 'Shortening of the Thrust (Nỗ lực rút ngắn)',
        meaning: 'Là một chuỗi các thanh bar cùng hướng (tăng hoặc giảm) nhưng có biên độ (spread) ngày càng thu hẹp, cho thấy xu hướng đang mất đà và sắp đảo chiều.',
        characteristics: [
            'Thường xuất hiện ở cuối một xu hướng tăng hoặc giảm.',
            'Các thanh Up-bar (trong xu hướng tăng) ngày càng ngắn lại dù volume có thể vẫn cao.',
            'Các thanh Down-bar (trong xu hướng giảm) có đáy không thấp hơn nhiều so với thanh trước.',
            'Đây là dấu hiệu suy yếu, không phải là tín hiệu hành động ngay lập tức.'
        ]
    },
    {
        title: 'Mẫu hình "Bánh mì kẹp thịt" (Sandwich)',
        meaning: 'Thể hiện một nỗ lực đảo chiều (tăng hoặc giảm) đã bị phe đối ứng hấp thụ hoàn toàn, cho thấy xu hướng ban đầu có khả năng tiếp tục.',
        characteristics: [
            'Là một chuỗi ít nhất 3 thanh bar liên tiếp.',
            'Thanh 1: Xác lập kỳ vọng ban đầu, thường có đuôi dài và đóng cửa gần cực trị.',
            'Thanh 2 (Giữa): Nỗ lực đảo chiều bị từ chối, có biên độ lớn hơn và đóng cửa ngược hướng thanh 1.',
            'Thanh 3: Xác nhận sự thất bại của nỗ lực đảo chiều, đóng cửa ủng hộ hướng của thanh 1.'
        ]
    },
    {
        title: 'Lằn ranh trên cát (Line in the Sand)',
        meaning: 'Cho thấy một bên đã hoàn toàn chiếm ưu thế trong phiên đó. Nếu các thanh bar sau phủ định lại thanh này, đó là một dấu hiệu hấp thụ rất mạnh.',
        characteristics: [
            'Là một thanh bar duy nhất có biên độ rất rộng.',
            'Giá đóng cửa nằm chính xác tại đỉnh hoặc đáy của thanh giá.',
            'Lằn ranh được vẽ tại râu trên (nếu đóng cửa cao nhất) hoặc râu dưới (nếu đóng cửa thấp nhất).',
            'Đây là "lằn ranh tâm lý" giữa phe mua và phe bán.'
        ]
    }
];

// New, detailed database for the interactive lookup tool
const vsaPatternsDatabase = [
    // Tại Vùng Cầu
    { title: 'Downbar hấp thụ cung', interpretation: 'Lực bán mạnh đã bị phe mua hấp thụ hoàn toàn. Tín hiệu đảo chiều tăng giá mạnh.', tags: { zone: 'demand', bar_type: 'down', spread: 'narrow', close_pos: 'high', volume: 'high' } },
    { title: 'Stopping Volume', interpretation: 'Dòng tiền lớn đã can thiệp để chặn đà giảm. Chờ tín hiệu xác nhận (ví dụ No Supply) để mua.', tags: { zone: 'demand', bar_type: 'down', spread: 'any', close_pos: 'mid_high', volume: 'very_high' } },
    { title: 'Selling Climax', interpretation: 'Sự hoảng loạn của đám đông và hành động mua vào của Smart Money. Tín hiệu tạo đáy tiềm năng rất cao.', tags: { zone: 'demand', bar_type: 'down', spread: 'wide', close_pos: 'mid_high', volume: 'very_high' } },
    { title: 'No Supply', interpretation: 'Áp lực bán đã cạn kiệt. Thị trường sẵn sàng cho một đợt tăng giá. Tín hiệu mua sớm.', tags: { zone: 'demand', bar_type: 'down', spread: 'narrow', close_pos: 'mid_low', volume: 'very_low' } },
    { title: 'Shakeout', interpretation: 'Smart Money đã rũ bỏ thành công người bán yếu. Tín hiệu mua rất mạnh.', tags: { zone: 'demand', bar_type: 'any', spread: 'wide', close_pos: 'high', volume: 'high' } },
    { title: 'Downbar tiếp diễn', interpretation: 'Lực bán vẫn đang chiếm ưu thế, lực mua tại vùng hỗ trợ là yếu. Khả năng cao giá sẽ giảm tiếp.', tags: { zone: 'demand', bar_type: 'down', spread: 'medium_wide', close_pos: 'low', volume: 'high' } },
    { title: 'Breakdown dứt khoát', interpretation: 'Vùng hỗ trợ đã bị phá vỡ với lực bán áp đảo. Xác nhận xu hướng giảm.', tags: { zone: 'demand', bar_type: 'down', spread: 'wide', close_pos: 'very_low', volume: 'very_high' } },
    { title: 'No Demand tại vùng cầu', interpretation: 'Nỗ lực phục hồi thất bại vì không có lực mua. Cảnh báo giá có thể giảm sâu hơn.', tags: { zone: 'demand', bar_type: 'up', spread: 'narrow', close_pos: 'mid', volume: 'low' } },
    
    // Tại Vùng Cung
    { title: 'Upbar hấp thụ cung', interpretation: 'Lực mua mạnh mẽ, đang hấp thụ hết lực bán tại kháng cự. Tín hiệu tốt cho khả năng vượt đỉnh.', tags: { zone: 'supply', bar_type: 'up', spread: 'medium_wide', close_pos: 'high', volume: 'high' } },
    { title: 'Breakout dứt khoát', interpretation: 'Vùng kháng cự bị phá vỡ với lực mua áp đảo. Xác nhận xu hướng tăng.', tags: { zone: 'supply', bar_type: 'up', spread: 'wide', close_pos: 'very_high', volume: 'very_high' } },
    { title: 'Upbar hấp thụ cầu (phân phối)', interpretation: 'Nỗ lực mua đã bị phe bán hấp thụ. Tín hiệu đảo chiều giảm giá mạnh.', tags: { zone: 'supply', bar_type: 'up', spread: 'narrow', close_pos: 'low', volume: 'high' } },
    { title: 'Buying Climax', interpretation: 'Bẫy tăng giá kinh điển. Smart Money bán ra mạnh mẽ sau khi dụ được người mua. Khả năng giảm mạnh.', tags: { zone: 'supply', bar_type: 'up', spread: 'wide', close_pos: 'mid_low', volume: 'very_high' } },
    { title: 'No Demand tại vùng cung', interpretation: 'Lực mua đã cạn kiệt, không ai muốn mua ở giá cao. Thị trường sẵn sàng cho một đợt giảm giá.', tags: { zone: 'supply', bar_type: 'up', spread: 'narrow', close_pos: 'mid', volume: 'low' } },
    { title: 'Upthrust', interpretation: 'Smart Money đã tạo bẫy tăng giá thành công để bán ra. Tín hiệu bán rất mạnh.', tags: { zone: 'supply', bar_type: 'any', spread: 'wide', close_pos: 'low', volume: 'high' } },
];


const tradingPlan = {
    title: 'Kế Hoạch Giao Dịch Toàn Diện',
    description: 'Một hệ thống VSA hoàn chỉnh không chỉ là phân tích mà còn là hành động có kế hoạch. Luôn tuân thủ các bước sau:',
    steps: [
        { title: 'Bước 1: Phân Tích Tổng Thể (Top-down)', content: 'Phân tích thị trường chung (VN-Index) và liên thị trường (nếu cần) để xác định xu hướng chính. Giao dịch thuận theo xu hướng lớn sẽ có xác suất thành công cao hơn.' },
        { title: 'Bước 2: Lựa Chọn Cổ Phiếu', content: 'Xác định các ngành đang dẫn dắt thị trường (sóng ngành). Sau đó, sử dụng phân tích sức mạnh tương đối (RS) để tìm ra cổ phiếu mạnh nhất trong ngành đó.' },
        { title: 'Bước 3: Phân Tích VSA Chi Tiết', content: 'Trên biểu đồ của cổ phiếu đã chọn, xác định các vùng Cung/Cầu quan trọng. Chờ đợi và tìm kiếm các tín hiệu VSA then chốt xuất hiện tại các vùng này.' },
        { title: 'Bước 4: Thực Thi Giao Dịch', content: 'Xác định điểm vào lệnh (Entry) sau khi có thanh bar xác nhận tín hiệu. Luôn đặt điểm dừng lỗ (Stoploss) một cách logic (ví dụ: dưới đáy Shakeout, trên đỉnh Upthrust) và xác định mục tiêu chốt lời (Take Profit) tại các vùng cản tiếp theo.' },
        { title: 'Bước 5: Quản Trị & Ghi Chép', content: 'Theo dõi chặt chẽ vị thế và sẵn sàng điều chỉnh khi có tín hiệu mới. Luôn ghi lại nhật ký giao dịch để phân tích, rút kinh nghiệm và cải thiện hệ thống.' }
    ]
};

const traderMindset = {
    title: 'Tâm Thức Giao Dịch',
    description: 'Thành công không chỉ đến từ phương pháp, mà còn từ một tâm lý vững vàng. Đây là những đức tính cần rèn luyện:',
    points: [
        { title: 'Kiên Nhẫn', content: 'Chờ đợi cơ hội rõ ràng nhất, đúng với kế hoạch của bạn. Không vào lệnh sớm, không giao dịch vì sốt ruột.' },
        { title: 'Kỷ Luật', content: 'Tuân thủ tuyệt đối hệ thống và kế hoạch đã đặt ra, từ điểm vào, dừng lỗ đến chốt lời. Không để cảm xúc chi phối quyết định.' },
        { title: 'Dũng Cảm', content: 'Dám chấp nhận rủi ro và thực hiện giao dịch khi tín hiệu xuất hiện. Quan trọng hơn, dám cắt lỗ một cách dứt khoát khi đã sai.' },
        { title: 'Khiêm Tốn', content: 'Luôn nhận thức rằng bạn có thể sai và thị trường luôn đúng. Không bao giờ chủ quan, luôn chuẩn bị cho kịch bản xấu nhất.' },
    ]
};

const quizQuestions = [
    { question: "Khi giá giảm về vùng Cầu với khối lượng thấp và biên độ hẹp, đó là tín hiệu gì?", options: ["Shakeout", "No Supply", "Stopping Volume", "Upthrust"], correct: 1, explanation: "No Supply là một Down-bar có biên độ hẹp và khối lượng thấp, cho thấy áp lực bán đã cạn kiệt tại vùng Cầu, một tín hiệu tốt cho phe mua." },
    { question: "Tại vùng Cung, bạn thấy một Up-bar có spread rộng, volume rất cao nhưng giá đóng cửa ở nửa dưới. Đây là tín hiệu của...?", options: ["Sức mạnh breakout.", "Buying Climax (Cao trào mua).", "Test cung thành công.", "No Demand."], correct: 1, explanation: "Đây là ví dụ kinh điển của nguyên tắc Nỗ Lực vs. Kết Quả. Nỗ lực tăng giá rất lớn (spread rộng, volume cao) nhưng kết quả lại thất bại (đóng cửa thấp), cho thấy phe bán đã hấp thụ hết lực mua." },
    { question: "Mẫu hình Shakeout có đặc điểm quan trọng nhất là gì?", options: ["Volume thấp và spread hẹp.", "Đóng cửa ở mức thấp nhất.", "Phá vỡ một mức hỗ trợ rồi phục hồi và đóng cửa cao.", "Xuất hiện ở vùng cung."], correct: 2, explanation: "Bản chất của Shakeout là một cú 'rũ bỏ' - giá phá vỡ hỗ trợ để loại bỏ người bán yếu, sau đó Smart Money nhanh chóng mua vào và đẩy giá phục hồi mạnh mẽ." },
    { question: "Một Up-bar có spread hẹp và volume thấp tại Vùng Cung được gọi là gì?", options: ["No Supply", "Stopping Volume", "Upthrust", "No Demand"], correct: 3, explanation: "Đây là tín hiệu No Demand, cho thấy sự cạn kiệt của lực mua. Không còn ai hứng thú mua ở mức giá cao, báo hiệu khả năng giảm giá." }
];

// --- COMPONENTS ---

const Header = ({ activeSection, setActiveSection }) => {
    const navItems = [
        { id: 'learn', label: 'Học VSA', icon: <BookOpen className="w-5 h-5 mr-2" /> },
        { id: 'lookup', label: 'Tra Cứu', icon: <Search className="w-5 h-5 mr-2" /> },
        { id: 'quiz', label: 'Kiểm Tra', icon: <CheckCircle className="w-5 h-5 mr-2" /> },
    ];
    return (<header className="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 shadow-lg shadow-cyan-500/10"><nav className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8"><div className="flex items-center justify-between h-16"><div className="flex-shrink-0"><h1 className="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-emerald-400 text-transparent bg-clip-text">VSA Master</h1></div><div className="hidden md:block"><div className="ml-10 flex items-baseline space-x-4">{navItems.map((item) => (<button key={item.id} onClick={() => setActiveSection(item.id)} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors duration-300 ${activeSection === item.id ? 'bg-cyan-500/10 text-cyan-300' : 'text-gray-300 hover:bg-gray-700/50 hover:text-white'}`}>{item.icon}{item.label}</button>))}</div></div></div></nav></header>);
};

const PairedPatternCard = ({ pattern, type }) => {
    if (!pattern) {
        return <div className="border border-dashed border-gray-700 rounded-lg min-h-full"></div>;
    }
    const isBullish = type === 'supply';
    return (
        <div className={`border-2 ${isBullish ? 'border-emerald-500/50' : 'border-red-500/50'} bg-gray-800/20 rounded-lg p-4 flex flex-col h-full`}>
            <div className="flex-grow">
                 <h4 className={`font-bold text-lg ${isBullish ? 'text-emerald-400' : 'text-red-400'}`}>{pattern.title}</h4>
                <div className="mt-3 space-y-2 text-gray-300 text-sm">
                    <div><strong className="font-semibold text-white w-20 inline-block">Spread:</strong> {pattern.analysis.spread}</div>
                    <div><strong className="font-semibold text-white w-20 inline-block">Volume:</strong> {pattern.analysis.volume}</div>
                    <div><strong className="font-semibold text-white w-20 inline-block">Close:</strong> {pattern.analysis.close}</div>
                </div>
            </div>
            <div className="mt-4 pt-3 border-t border-gray-600/50">
                 <p className={`font-semibold text-center text-lg ${isBullish ? 'text-emerald-300' : 'text-red-300'}`}>{pattern.result}</p>
            </div>
        </div>
    );
}

const AbsorptionZoneSection = ({ zone, description, pairs }) => {
    return (
        <div>
            <div className="text-center mb-6">
                <h3 className="text-2xl font-bold text-white">{zone}</h3>
                <p className="text-gray-400 mt-1">{description}</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                 <h4 className="text-xl font-semibold text-emerald-400 text-center md:mb-2">Tín hiệu Hấp thụ CUNG (Tích cực)</h4>
                 <h4 className="text-xl font-semibold text-red-400 text-center md:mb-2">Tín hiệu Hấp thụ CẦU (Tiêu cực)</h4>
                 {pairs.map((pair, index) => (
                    <React.Fragment key={index}>
                       <PairedPatternCard pattern={pair.supply} type="supply" />
                       <PairedPatternCard pattern={pair.demand} type="demand" />
                    </React.Fragment>
                 ))}
            </div>
        </div>
    )
}

const LearningPage = () => {
    return (
        <div className="animate-fade-in space-y-12">
            <div>
                <div className="text-center mb-8">
                    <h2 className="text-3xl font-extrabold text-white tracking-tight">{learningPath[0].title}</h2>
                    <p className="mt-2 max-w-2xl mx-auto text-lg text-gray-400">{learningPath[0].description}</p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {learningPath[0].concepts.map(c => (
                        <div key={c.id} className="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div className="sm:border-r border-gray-700 pr-4 flex flex-col justify-center">
                                    <h3 className="text-xl font-bold text-cyan-400">{c.title}</h3>
                                    <p className="mt-3 text-gray-300">{c.content}</p>
                                </div>
                                <div className="flex items-center justify-center min-h-[120px]">
                                    {c.illustration}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
            <div className="space-y-12">
                <div className="text-center">
                    <h2 className="text-3xl font-extrabold text-white tracking-tight">So sánh các Mẫu Hình Hấp Thụ</h2>
                </div>
                {absorptionPairsByZone.map(zoneData => <AbsorptionZoneSection key={zoneData.zone} {...zoneData} />)}
            </div>
             {/* Special Patterns Section */}
            <div>
                <div className="text-center mb-8">
                    <h2 className="text-3xl font-extrabold text-white tracking-tight">Các Mẫu Hình VSA Đặc Biệt</h2>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    {specialPatterns.map(pattern => (
                        <div key={pattern.title} className="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                            <h3 className="text-xl font-bold text-cyan-400 mb-2">{pattern.title}</h3>
                            <p className="text-gray-300 italic mb-4">"{pattern.meaning}"</p>
                            <ul className="space-y-2 list-none pl-0">
                                {pattern.characteristics.map((char, index) => (
                                    <li key={index} className="flex items-start">
                                        <CheckCircle className="w-5 h-5 text-emerald-400 flex-shrink-0 mr-3 mt-1" />
                                        <span className="text-gray-400">{char}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    ))}
                </div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                 <div>
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-extrabold text-white tracking-tight">{tradingPlan.title}</h2>
                    </div>
                    <div className="max-w-3xl mx-auto bg-gray-800/50 border border-gray-700 rounded-lg p-8 space-y-6">
                        {tradingPlan.steps.map(step => (
                            <div key={step.title} className="flex items-start">
                                <ClipboardList className="w-8 h-8 text-cyan-400 flex-shrink-0 mr-4 mt-1" />
                                <div>
                                    <h4 className="text-xl font-bold text-white">{step.title}</h4>
                                    <p className="mt-1 text-gray-300">{step.content}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
                 <div>
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-extrabold text-white tracking-tight">{traderMindset.title}</h2>
                    </div>
                    <div className="max-w-3xl mx-auto bg-gray-800/50 border border-gray-700 rounded-lg p-8 space-y-6">
                        {traderMindset.points.map(point => (
                            <div key={point.title} className="flex items-start">
                                <Shield className="w-8 h-8 text-emerald-400 flex-shrink-0 mr-4 mt-1" />
                                <div>
                                    <h4 className="text-xl font-bold text-white">{point.title}</h4>
                                    <p className="mt-1 text-gray-300">{point.content}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};


const LookupPage = () => {
    const [filters, setFilters] = useState({
        zone: 'any',
        bar_type: 'any',
        spread: 'any',
        close_pos: 'any',
        volume: 'any'
    });

    const handleFilterChange = (filterName, value) => {
        setFilters(prev => ({ ...prev, [filterName]: value }));
    };

    const filterOptions = {
        zone: [{value: 'any', label: 'Bất kỳ'}, {value: 'supply', label: 'Vùng Cung'}, {value: 'demand', label: 'Vùng Cầu'}],
        bar_type: [{value: 'any', label: 'Bất kỳ'}, {value: 'up', label: 'Upbar'}, {value: 'down', label: 'Downbar'}],
        spread: [{value: 'any', label: 'Bất kỳ'}, {value: 'narrow', label: 'Hẹp'}, {value: 'medium', label: 'Trung bình'}, {value: 'wide', label: 'Rộng'}],
        close_pos: [{value: 'any', label: 'Bất kỳ'}, {value: 'very_high', label: 'Rất cao'}, {value: 'high', label: 'Trên 1/2'}, {value: 'mid', label: 'Giữa'}, {value: 'low', label: 'Dưới 1/2'}, {value: 'very_low', label: 'Rất thấp'}],
        volume: [{value: 'any', label: 'Bất kỳ'}, {value: 'very_low', label: 'Rất thấp'}, {value: 'low', label: 'Thấp'}, {value: 'medium', label: 'Trung bình'}, {value: 'high', label: 'Cao'}, {value: 'very_high', label: 'Rất cao'}]
    };
    
    // This is the new, smarter matching logic
    const analysisResult = useMemo(() => {
        if (Object.values(filters).every(v => v === 'any')) {
            return { matched: [], generic: null };
        }

        const scorePattern = (pattern) => {
            let score = 0;
            const weights = { zone: 5, bar_type: 3, spread: 2, close_pos: 4, volume: 4 };

            // Critical rule: Effort vs Result
            const high_effort = ['high', 'very_high'].includes(filters.volume) || filters.spread === 'wide';
            const poor_result_up = ['low', 'very_low'].includes(filters.close_pos);
            const poor_result_down = ['high', 'very_high'].includes(filters.close_pos);

            // Penalize contradictions
            if(filters.bar_type === 'up' && high_effort && poor_result_up) {
                 if(pattern.title.toLowerCase().includes('breakout')) return 0; // Contradiction, disqualify
                 if(pattern.title.toLowerCase().includes('phân phối') || pattern.title.toLowerCase().includes('upthrust') || pattern.title.toLowerCase().includes('climax')) score += 5; // Reward
            }
             if(filters.bar_type === 'down' && high_effort && poor_result_down) {
                 if(pattern.title.toLowerCase().includes('hấp thụ cung')) return 0; // Contradiction, disqualify
                 if(pattern.title.toLowerCase().includes('tiếp diễn')) score += 5; // Reward
            }
            
            // Match zone
            if (filters.zone !== 'any') {
                if (pattern.tags.zone === filters.zone) score += weights.zone;
                else return 0; 
            }
            
            // Match other tags
            const checkMatch = (key) => {
                 if (filters[key] !== 'any' && pattern.tags[key] !== 'any') {
                    if (pattern.tags[key].includes(filters[key])) score += weights[key];
                 }
            }

            checkMatch('bar_type');
            checkMatch('spread');
            checkMatch('close_pos');
            checkMatch('volume');
            
            return score;
        };

        const scoredPatterns = vsaPatternsDatabase
            .map(p => ({ ...p, score: scorePattern(p) }))
            .filter(p => p.score > 0)
            .sort((a, b) => b.score - a.score);

        if (scoredPatterns.length > 0 && scoredPatterns[0].score > 6) {
            return { matched: scoredPatterns.slice(0, 2), generic: null };
        }
        
        // --- Generic Interpretation Logic ---
        const getDesc = (obj, key) => obj.find(o => o.value === key)?.label || '';
        
        let interpretation = '';
        const zonePart = filters.zone !== 'any' ? `Tại **${getDesc(filterOptions.zone, filters.zone)}**` : '';
        if (zonePart) interpretation += zonePart;
        
        let actionPart = '';
        if (filters.bar_type !== 'any') {
            actionPart = `một nỗ lực **${filters.bar_type === 'up' ? 'tăng giá (Up-bar)' : 'giảm giá (Down-bar)'}**`;
        }

        let detailParts = [];
        if (filters.spread !== 'any') {
            detailParts.push(`Spread **${getDesc(filterOptions.spread, filters.spread).toLowerCase()}**`);
        }
        if (filters.volume !== 'any') {
            detailParts.push(`Volume **${getDesc(filterOptions.volume, filters.volume).toLowerCase()}**`);
        }

        if(detailParts.length > 0) {
            actionPart += ` với ${detailParts.join(' và ')}`;
        }

        if(actionPart){
            if(interpretation) {
                 interpretation += `, ${actionPart}`;
            } else {
                 actionPart = actionPart.charAt(0).toUpperCase() + actionPart.slice(1);
                 interpretation += actionPart;
            }
        }
        
        let conclusionPart = '';
        if (filters.close_pos !== 'any') {
            const closeDesc = getDesc(filterOptions.close_pos, filters.close_pos).toLowerCase();
            if (['rất cao', 'trên 1/2'].includes(closeDesc)) conclusionPart = `cho thấy **phe mua đang chiếm ưu thế** cuối phiên`;
            else if (['rất thấp', 'dưới 1/2'].includes(closeDesc)) conclusionPart = `cho thấy **phe bán đã can thiệp mạnh** và chiếm ưu thế cuối phiên`;
            else conclusionPart = `cho thấy **sự giằng co** giữa hai bên`;
            
            if(interpretation) {
                interpretation += `, ${conclusionPart}`;
            } else {
                conclusionPart = conclusionPart.charAt(0).toUpperCase() + conclusionPart.slice(1);
                interpretation += conclusionPart;
            }
        }
        
        const genericInterpretation = interpretation ? interpretation.trim() + '.' : null;

        return { matched: [], generic: genericInterpretation };

    }, [filters]);
    
    const FilterSelect = ({ name, label, value, onChange }) => (
        <div>
            <label htmlFor={name} className="block text-sm font-medium text-gray-400">{label}</label>
            <select
                id={name} name={name} value={value}
                onChange={(e) => onChange(name, e.target.value)}
                className="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-800 border-gray-600 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 sm:text-sm rounded-md"
            >
                {filterOptions[name].map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
            </select>
        </div>
    );

    return (
        <div className="animate-fade-in">
            <h2 className="text-3xl font-bold text-white text-center">Công Cụ Phân Tích Thanh Bar</h2>
            <p className="text-center text-gray-400 mt-2 max-w-2xl mx-auto">Chọn các đặc điểm của thanh bar bạn muốn phân tích để nhận diễn giải.</p>

            <div className="mt-8 p-6 bg-gray-800/50 border border-gray-700 rounded-lg">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    {Object.keys(filters).map((key, i) => (
                        <FilterSelect key={key} name={key} label={`${i + 1}. ${key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`} value={filters[key]} onChange={handleFilterChange} />
                    ))}
                </div>
            </div>

            <div className="mt-8">
                 <h3 className="text-xl font-semibold text-white">Kết quả phân tích:</h3>
                 <div className="mt-4">
                    {analysisResult.matched.length > 0 ? (
                        <>
                         <p className="text-sm text-gray-400 mb-4">Dưới đây là các mẫu hình kinh điển phù hợp nhất với lựa chọn của bạn:</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {analysisResult.matched.map(p => (
                                <div key={p.title} className={`p-6 rounded-lg border-2 ${p.interpretation.includes('TĂNG') || p.interpretation.includes('mua') ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-red-900/20 border-red-500/50'}`}>
                                    <h4 className={`text-xl font-bold ${p.interpretation.includes('TĂNG') || p.interpretation.includes('mua') ? 'text-emerald-300' : 'text-red-300'}`}>{p.title}</h4>
                                    <p className="mt-2 text-gray-300">{p.interpretation}</p>
                                </div>
                            ))}
                        </div>
                        </>
                    ) : analysisResult.generic ? (
                        <div className="text-center py-8 text-gray-300 bg-gray-800/30 rounded-lg px-6">
                             <h4 className="text-lg font-semibold text-cyan-400">Diễn giải theo Nguyên tắc VSA</h4>
                             <p className="mt-2" dangerouslySetInnerHTML={{ __html: analysisResult.generic.replace(/\*\*([^*]+)\*\*/g, '<strong class="text-cyan-300">$1</strong>') }} />
                        </div>
                    ) : (
                         <div className="text-center py-12 text-gray-500 bg-gray-800/30 rounded-lg">
                            <p className="text-lg">Vui lòng chọn các tiêu chí để bắt đầu phân tích.</p>
                        </div>
                    )}
                 </div>
            </div>
        </div>
    );
};

const QuizPage = () => {
    const [currentQuestion, setCurrentQuestion] = useState(0);
    const [selectedAnswer, setSelectedAnswer] = useState(null);
    const [score, setScore] = useState(0);
    const [showResult, setShowResult] = useState(false);
    const handleAnswer = (optionIndex) => { setSelectedAnswer(optionIndex); if (optionIndex === quizQuestions[currentQuestion].correct) { setScore(prev => prev + 1); }};
    const handleNext = () => { if (currentQuestion < quizQuestions.length - 1) { setCurrentQuestion(prev => prev + 1); setSelectedAnswer(null);} else { setShowResult(true); }};
    const handleReset = () => { setCurrentQuestion(0); setSelectedAnswer(null); setScore(0); setShowResult(false); };
    if (showResult) {
        return ( <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-8 text-center animate-fade-in max-w-2xl mx-auto"> <h2 className="text-3xl font-bold text-white">Kết Quả</h2> <p className="mt-4 text-5xl font-extrabold bg-gradient-to-r from-cyan-400 to-emerald-400 text-transparent bg-clip-text">{score} / {quizQuestions.length}</p> <p className="mt-2 text-gray-400 text-lg">{score / quizQuestions.length >= 0.75 ? "Tuyệt vời! Bạn đã nắm rất vững kiến thức." : "Cố gắng lên! Hãy ôn lại các khái niệm nhé."}</p> <button onClick={handleReset} className="mt-8 bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-cyan-600 transition-colors">Làm Lại</button> </div>);
    }
    const question = quizQuestions[currentQuestion];
    return (
        <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-6 md:p-8 animate-fade-in max-w-2xl mx-auto">
            <p className="text-sm text-gray-400">Câu {currentQuestion + 1} của {quizQuestions.length}</p>
            <h2 className="mt-2 text-xl md:text-2xl font-bold text-white">{question.question}</h2>
            <div className="mt-6 space-y-4">
                {question.options.map((option, index) => {
                    const isSelected = selectedAnswer === index; const isCorrect = question.correct === index;
                    let optionClass = 'bg-gray-800 border-gray-700 hover:bg-gray-700/50 hover:border-cyan-400';
                    if (selectedAnswer !== null) { if(isCorrect) optionClass = 'bg-emerald-500/20 border-emerald-500'; else if (isSelected && !isCorrect) optionClass = 'bg-red-500/20 border-red-500'; }
                    return (<button key={index} onClick={() => handleAnswer(index)} disabled={selectedAnswer !== null} className={`w-full text-left p-4 rounded-lg border-2 transition-all duration-300 ${optionClass}`}>{option}</button>);
                })}
            </div>
            {selectedAnswer !== null && (
                <div className="mt-6 p-4 bg-gray-900/50 rounded-lg animate-fade-in">
                    <p className="font-bold text-emerald-400">Giải thích:</p>
                    <p className="mt-2 text-gray-300">{question.explanation}</p>
                    <button onClick={handleNext} className="mt-4 w-full bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-cyan-600 transition-colors">{currentQuestion < quizQuestions.length - 1 ? 'Câu Tiếp Theo' : 'Xem Kết Quả'}</button>
                </div>
            )}
        </div>
    );
};

// --- MAIN APP COMPONENT ---
export default function App() {
    const [activeSection, setActiveSection] = useState('learn');
    const renderSection = () => { switch (activeSection) { case 'learn': return <LearningPage />; case 'lookup': return <LookupPage />; case 'quiz': return <QuizPage />; default: return <LearningPage />; }};
    return (
        <div className="min-h-screen bg-gray-900 text-gray-200 font-sans">
            <Header activeSection={activeSection} setActiveSection={setActiveSection} />
            <main className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
                {renderSection()}
            </main>
             <footer className="text-center py-6 text-gray-500 text-sm">
                <p>Xây dựng với React & Tailwind CSS. Chúc bạn học tốt!</p>
            </footer>
        </div>
    );
}
