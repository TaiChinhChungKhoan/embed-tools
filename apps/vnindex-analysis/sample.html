import React, { useState, useMemo } from 'react';
import {
  ComposedChart,
  Scatter,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ReferenceArea,
  ReferenceLine,
  ResponsiveContainer
} from 'recharts';

// Sample data generator (can be moved to a separate module)
const generateSampleData = () => {
  const stocks = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA'];
  const signals = ['Strong Uptrend', 'Neutral', 'Strong Downtrend'];
  return stocks.map((stock) => {
    let rsRatio = 100 + (Math.random() - 0.5) * 10;
    let rsMomentum = 100 + (Math.random() - 0.5) * 10;
    const trail = Array.from({ length: 30 }).map(() => {
      rsRatio += (Math.random() - 0.5) * 0.8;
      rsMomentum += (Math.random() - 0.5) * 0.8;
      return { rsRatio, rsMomentum };
    });
    const head = trail[trail.length - 1];
    const state = head.rsRatio > 100
      ? (head.rsMomentum > 100 ? 'Leading' : 'Weakening')
      : (head.rsMomentum > 100 ? 'Improving' : 'Lagging');
    return {
      name: stock,
      trail,
      head: {
        ...head,
        name: stock,
        state,
        duration: Math.floor(Math.random() * 20) + 5,
        signal: signals[Math.floor(Math.random() * signals.length)],
        size: (Math.random() * 20 + 10) * 10
      }
    };
  });
};

// Custom Tooltip
const CustomTooltip = ({ active, payload }) => {
  if (active && payload && payload.length) {
    const d = payload[0].payload;
    return (
      <div className="p-3 bg-white/95 backdrop-blur-sm shadow-lg rounded-lg border border-gray-200 text-sm">
        <strong className="text-base">{d.name}</strong>
        <hr className="my-1 border-gray-200" />
        <p><strong>RS-Ratio:</strong> {d.rsRatio.toFixed(2)}</p>
        <p><strong>RS-Momentum:</strong> {d.rsMomentum.toFixed(2)}</p>
        <p><strong>State:</strong> {d.state}</p>
        <p><strong>Duration:</strong> {d.duration} days</p>
        <p><strong>Signal:</strong> {d.signal}</p>
      </div>
    );
  }
  return null;
};

// Color interpolation for duration
const getColorForDuration = (duration, min, max) => {
  const ratio = (duration - min) / (max - min || 1);
  const start = [59, 130, 246];
  const end = [239, 68, 68];
  const rgb = start.map((s, i) => Math.round(s + ratio * (end[i] - s)));
  return `rgb(${rgb.join(',')})`;
};

// RRG Chart Component
export default function RRGChart() {
  const [data, setData] = useState(generateSampleData());

  // Extract head points
  const headData = useMemo(() => data.map(d => d.head), [data]);

  // Duration range for color scale
  const [minDur, maxDur] = useMemo(() => {
    const durs = headData.map(d => d.duration);
    return [Math.min(...durs), Math.max(...durs)];
  }, [headData]);

  // Flatten all points to calculate symmetric domains around 100
  const allRatios = useMemo(() => data.flatMap(d => d.trail.map(p => p.rsRatio).concat(d.head.rsRatio)), [data]);
  const allMomentums = useMemo(() => data.flatMap(d => d.trail.map(p => p.rsMomentum).concat(d.head.rsMomentum)), [data]);

  const xRange = Math.max(...allRatios.map(r => Math.abs(r - 100)));
  const yRange = Math.max(...allMomentums.map(m => Math.abs(m - 100)));
  const domainX = [100 - xRange, 100 + xRange];
  const domainY = [100 - yRange, 100 + yRange];

  return (
    <div className="w-full h-[600px]">
      <button
        onClick={() => setData(generateSampleData())}
        className="mb-2 px-4 py-2 bg-blue-500 text-white rounded-lg"
      >Refresh Data</button>

      <ResponsiveContainer>
        <ComposedChart data={headData} margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
          <CartesianGrid strokeDasharray="3 3" />

          {/* Quadrant backgrounds (symmetric) */}
          <ReferenceArea x1={100} x2={domainX[1]} y1={100} y2={domainY[1]} fill="#10b98122" />
          <ReferenceArea x1={100} x2={domainX[1]} y1={domainY[0]} y2={100} fill="#f59e0b22" />
          <ReferenceArea x1={domainX[0]} x2={100} y1={domainY[0]} y2={100} fill="#ef444422" />
          <ReferenceArea x1={domainX[0]} x2={100} y1={100} y2={domainY[1]} fill="#3b82f622" />

          {/* Quadrant labels */}
          <text x={(100 + domainX[1]) / 2} y={(100 + domainY[1]) / 2} textAnchor="middle" fill="#10b981" fontSize={14} fontWeight="600">Leading</text>
          <text x={(100 + domainX[1]) / 2} y={(domainY[0] + 100) / 2} textAnchor="middle" fill="#f59e0b" fontSize={14} fontWeight="600">Weakening</text>
          <text x={(domainX[0] + 100) / 2} y={(domainY[0] + 100) / 2} textAnchor="middle" fill="#ef4444" fontSize={14} fontWeight="600">Lagging</text>
          <text x={(domainX[0] + 100) / 2} y={(100 + domainY[1]) / 2} textAnchor="middle" fill="#3b82f6" fontSize={14} fontWeight="600">Improving</text>

          {/* Center lines */}
          <ReferenceLine x={100} stroke="#6b7280" />
          <ReferenceLine y={100} stroke="#6b7280" />

          {/* Axes */}
          <XAxis dataKey="rsRatio" type="number" domain={domainX} label={{ value: 'RS-Ratio', position: 'insideBottom', offset: -5 }} />
          <YAxis dataKey="rsMomentum" type="number" domain={domainY} label={{ value: 'RS-Momentum', angle: -90, position: 'insideLeft' }} />

          {/* Trails using <Line> for auto-scaling */}
          {data.map(stock => (
            <Line
              key={`trail-${stock.name}`}
              data={stock.trail.map(p => ({ ...p, name: stock.name, duration: stock.head.duration }))}
              type="monotone"
              dataKey="rsMomentum"
              stroke={getColorForDuration(stock.head.duration, minDur, maxDur)}
              dot={false}
              strokeDasharray="4 4"
              isAnimationActive={false}
            />
          ))}

          {/* Head points with custom shapes */}
          <Scatter
            data={headData}
            dataKey="rsMomentum"
            name="Head"
            shape={(props) => {
              const { cx, cy, payload } = props;
              const color = getColorForDuration(payload.duration, minDur, maxDur);
              if (payload.signal === 'Strong Uptrend') {
                const path = Array.from({ length: 10 }).map((_, i) => {
                  const r = i % 2 === 0 ? 8 : 3.2;
                  const ang = (Math.PI / 5) * i - Math.PI / 2;
                  return `${i === 0 ? 'M' : 'L'}${cx + r * Math.cos(ang)},${cy + r * Math.sin(ang)}`;
                }).join(' ') + 'Z';
                return <path d={path} fill={color} stroke={color} strokeWidth={1} />;
              } else if (payload.signal === 'Strong Downtrend') {
                const size = 8;
                return <polygon points={`${cx},${cy+size} ${cx-size*0.866},${cy-size*0.5} ${cx+size*0.866},${cy-size*0.5}`} fill={color} stroke={color} strokeWidth={1} />;
              }
              return <circle cx={cx} cy={cy} r={6} fill={color} stroke={color} strokeWidth={1} />;
            }}
          />

          <Tooltip content={<CustomTooltip />} cursor={false} />
        </ComposedChart>
      </ResponsiveContainer>
    </div>
  );
}
