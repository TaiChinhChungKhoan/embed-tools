<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n T√≠ch B√°t T·ª± & G·ª£i √ù ƒê·∫ßu T∆∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
        try {
            // Load required libraries from skypack
            const { BaziCalculator } = await import('https://cdn.skypack.dev/@aharris02/bazi-calculator-by-alvamind');
            const { toDate } = await import('https://cdn.skypack.dev/date-fns-tz');
            
            // Attach to window object for React component to use
            window.BaziCalculator = BaziCalculator;
            window.dateFnsTz = { toDate };

            // Dispatch event to notify React that libraries are ready
            window.dispatchEvent(new CustomEvent('bazi-library-ready'));
        } catch (e) {
            console.error("Failed to load Bazi libraries:", e);
        }
    </script>

    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
            transition: all 0.3s ease;
        }
        .pillar-card {
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .stem { font-size: 1.5rem; font-weight: 600; }
        .branch { font-size: 1.25rem; }
        .element-icon { width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .luck-pillar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .interaction-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 2px;
        }
        .bar-chart-bar {
            height: 20px;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        .info-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #e2e8f0;
            color: #4a5568;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            border: 1px solid #cbd5e0;
        }
        .modal-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .modal-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
         .modal-content li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- DATA & HELPERS ---
        
        const STYLE_CLASSES = {
            'M·ªôc': { text: 'text-green-600', bg: 'bg-green-50', border: 'border-green-400', tag: 'bg-green-100 text-green-800', chart: 'bg-green-500' },
            'H·ªèa': { text: 'text-red-600', bg: 'bg-red-50', border: 'border-red-400', tag: 'bg-red-100 text-red-800', chart: 'bg-red-500' },
            'Th·ªï': { text: 'text-yellow-600', bg: 'bg-yellow-50', border: 'border-yellow-400', tag: 'bg-yellow-100 text-yellow-800', chart: 'bg-yellow-500' },
            'Kim': { text: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-400', tag: 'bg-blue-100 text-blue-800', chart: 'bg-blue-500' },
            'Th·ªßy': { text: 'text-gray-600', bg: 'bg-gray-50', border: 'border-gray-400', tag: 'bg-gray-100 text-gray-800', chart: 'bg-gray-500' },
            'good': { tag: 'bg-green-100 text-green-800' },
            'bad': { tag: 'bg-red-100 text-red-800' }
        };

        const TRANSLATIONS = {
            stems: { 'Jia': 'Gi√°p', 'Yi': '·∫§t', 'Bing': 'B√≠nh', 'Ding': 'ƒêinh', 'Wu': 'M·∫≠u', 'Ji': 'K·ª∑', 'Geng': 'Canh', 'Xin': 'T√¢n', 'Ren': 'Nh√¢m', 'Gui': 'Qu√Ω' },
            branches: { 'Zi': 'T√Ω', 'Chou': 'S·ª≠u', 'Yin': 'D·∫ßn', 'Mao': 'M√£o', 'Chen': 'Th√¨n', 'Si': 'T·ªµ', 'Wu': 'Ng·ªç', 'Wei': 'M√πi', 'Shen': 'Th√¢n', 'You': 'D·∫≠u', 'Xu': 'Tu·∫•t', 'Hai': 'H·ª£i' },
            animals: { 'Rat': 'Chu·ªôt', 'Ox': 'Tr√¢u', 'Tiger': 'H·ªï', 'Rabbit': 'Th·ªè', 'Dragon': 'R·ªìng', 'Snake': 'R·∫Øn', 'Horse': 'Ng·ª±a', 'Goat': 'D√™', 'Monkey': 'Kh·ªâ', 'Rooster': 'G√†', 'Dog': 'Ch√≥', 'Pig': 'L·ª£n' },
            elements: { 'WOOD': 'M·ªôc', 'FIRE': 'H·ªèa', 'EARTH': 'Th·ªï', 'METAL': 'Kim', 'WATER': 'Th·ªßy' },
            interactions: { 'combination': 'H·ª£p', 'clash': 'Xung', 'harm': 'H·∫°i', 'punishment': 'H√¨nh', 'destruction': 'Ph√°' },
            tenGods: {'Friend': 'T·ª∑ Ki√™n', 'Rob Wealth': 'Ki·∫øp T√†i', 'Eating God': 'Th·ª±c Th·∫ßn', 'Hurting Officer': 'Th∆∞∆°ng Quan', 'Indirect Wealth': 'Thi√™n T√†i', 'Direct Wealth': 'Ch√≠nh T√†i', 'Seven Killings': 'Th·∫•t S√°t', 'Direct Officer': 'Ch√≠nh Quan', 'Indirect Resource': 'Thi√™n ·∫§n', 'Direct Resource': 'Ch√≠nh ·∫§n'},
            eightMansions: { 'wealth': 'T√†i L·ªôc', 'health': 'Thi√™n Y', 'romance': 'Di√™n Ni√™n', 'career': 'Ph·ª•c V·ªã', 'obstacles': 'H·ªça H·∫°i', 'quarrels': 'Ng≈© Qu·ª∑', 'lawsuits': 'L·ª•c S√°t', 'totalLoss': 'Tuy·ªát M·ªánh' },
            directions: {'N': 'B·∫Øc', 'S': 'Nam', 'E': 'ƒê√¥ng', 'W': 'T√¢y', 'NE': 'ƒê√¥ng B·∫Øc', 'SE': 'ƒê√¥ng Nam', 'SW': 'T√¢y Nam', 'NW': 'T√¢y B·∫Øc'}
        };
        const INDUSTRY_MAP = { 'M·ªôc': [{ name: 'N√¥ng & L√¢m nghi·ªáp', desc: 'Tr·ªìng tr·ªçt, ch·∫ø bi·∫øn g·ªó, gi·∫•y.' }, { name: 'D·ªát may & Da gi√†y', desc: 'S·∫£n xu·∫•t qu·∫ßn √°o, v·∫£i, gi√†y d√©p.' }, { name: 'Gi√°o d·ª•c & Xu·∫•t b·∫£n', desc: 'Tr∆∞·ªùng h·ªçc, s√°ch, b√°o ch√≠, truy·ªÅn th√¥ng.' }, { name: 'Y t·∫ø & ChƒÉm s√≥c s·ª©c kh·ªèe (Th·∫£o d∆∞·ª£c)', desc: 'ƒê√¥ng y, d∆∞·ª£c li·ªáu, s·∫£n ph·∫©m t·ª± nhi√™n.' }], 'H·ªèa': [{ name: 'NƒÉng l∆∞·ª£ng', desc: 'D·∫ßu kh√≠, ƒëi·ªán, nƒÉng l∆∞·ª£ng t√°i t·∫°o.' }, { name: 'C√¥ng ngh·ªá cao & ƒêi·ªán t·ª≠', desc: 'Ph·∫ßn m·ªÅm, internet, b√°n d·∫´n, vi·ªÖn th√¥ng.' }, { name: 'Gi·∫£i tr√≠ & M·ªπ ph·∫©m', desc: 'Phim ·∫£nh, nh√† h√†ng, kh√°ch s·∫°n, m·ªπ ph·∫©m.' }, { name: 'H√≥a ch·∫•t & Nh·ª±a', desc: 'S·∫£n xu·∫•t h√≥a ch·∫•t c∆° b·∫£n, nh·ª±a.' }], 'Th·ªï': [{ name: 'B·∫•t ƒë·ªông s·∫£n', desc: 'Ph√°t tri·ªÉn, kinh doanh, cho thu√™ BƒêS.' }, { name: 'X√¢y d·ª±ng & V·∫≠t li·ªáu', desc: 'X√¢y d·ª±ng c√¥ng tr√¨nh, s·∫£n xu·∫•t xi mƒÉng, g·∫°ch.' }, { name: 'B·∫£o hi·ªÉm', desc: 'B·∫£o hi·ªÉm nh√¢n th·ªç v√† phi nh√¢n th·ªç.' }, { name: 'Khai kho√°ng', desc: 'Khai th√°c t√†i nguy√™n kho√°ng s·∫£n.' }], 'Kim': [{ name: 'T√†i ch√≠nh & Ng√¢n h√†ng', desc: 'Ng√¢n h√†ng, c√¥ng ty ch·ª©ng kho√°n, qu·∫£n l√Ω qu·ªπ.' }, { name: 'C∆° kh√≠ & S·∫£n xu·∫•t m√°y m√≥c', desc: 'S·∫£n xu·∫•t √¥ t√¥, thi·∫øt b·ªã c√¥ng nghi·ªáp.' }, { name: 'Kim lo·∫°i & Th√©p', desc: 'S·∫£n xu·∫•t, kinh doanh th√©p, kim lo·∫°i qu√Ω.' }, { name: 'C√¥ng ngh·ªá (Ph·∫ßn c·ª©ng)', desc: 'S·∫£n xu·∫•t m√°y t√≠nh, thi·∫øt b·ªã ƒëi·ªán t·ª≠.' }], 'Th·ªßy': [{ name: 'V·∫≠n t·∫£i & Logistics', desc: 'H√†ng kh√¥ng, c·∫£ng bi·ªÉn, v·∫≠n chuy·ªÉn h√†ng h√≥a.' }, { name: 'Th∆∞∆°ng m·∫°i & B√°n l·∫ª', desc: 'Si√™u th·ªã, xu·∫•t nh·∫≠p kh·∫©u, b√°n l·∫ª.' }, { name: 'Du l·ªãch & D·ªãch v·ª•', desc: 'L·ªØ h√†nh, kh√°ch s·∫°n, d·ªãch v·ª• ƒÉn u·ªëng.' }, { name: 'Th·ªßy s·∫£n', desc: 'Nu√¥i tr·ªìng v√† ch·∫ø bi·∫øn th·ªßy h·∫£i s·∫£n.' }] };
        const WUXING_RELATIONS = { produces: { 'M·ªôc': 'H·ªèa', 'H·ªèa': 'Th·ªï', 'Th·ªï': 'Kim', 'Kim': 'Th·ªßy', 'Th·ªßy': 'M·ªôc' }, controls: { 'M·ªôc': 'Th·ªï', 'H·ªèa': 'Kim', 'Th·ªï': 'Th·ªßy', 'Kim': 'M·ªôc', 'Th·ªßy': 'H·ªèa' }, };
        
        const SVG_PATHS = { 'M·ªôc': 'M17.5 1a4.5 4.5 0 00-4.47 4.96l-2.6 1.73A4.5 4.5 0 106.5 13H10v2a3 3 0 003 3h1a3 3 0 003-3v-2h3.5a4.5 4.5 0 100-9H13.04A4.5 4.5 0 0017.5 1zM6.5 10a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm11 7a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm0-11a1.5 1.5 0 110-3 1.5 1.5 0 010 3z', 'H·ªèa': 'M11.33 2.03c.59-.59 1.71-.23 1.95.62.18.66.71 1.13 1.39 1.13.93 0 1.63-1.07 1.22-1.93a3.5 3.5 0 00-4.95-4.95C10.07-.5 9 1.1 9 2c0 .69.47 1.21 1.13 1.39.78.2 1.41-.34 1.2-1.36zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm4.27 7.27c-3.17 3.17-8.36 3.17-11.54 0-2.31-2.31-2.9-6.09-1.38-9.15.59-1.18 2.2-1.18 2.79 0C8.73 8.31 9.8 11.23 12 12c.98 0 1.88-.35 2.62-.94.7-.56.89-1.6.33-2.3a1.5 1.5 0 012.3-.33c.96.96 1.2 2.48.56 3.72l-1.54 2.82z', 'Th·ªï': 'M21 3H3v2h18V3zM3 21h18v-2H3v2zM12.41 6.59l-2-2-2 2L10 8l-2.09-.59-2 2L6.59 10 5 11.59l2 2 .59-1.41L8 10l1.41.59 2-2L10.82 8l1.59-1.41zm-.82 8.82l-2 2-2-2L10 16l-2.09.59-2-2L6.59 14 5 12.41l2-2 .59 1.41L8 14l1.41-.59 2 2L10.82 16l1.59 1.41zM20.5 11.5L19 10l-1.41 1.41L16 10l-1.41 1.41L16 14l1.59-1.41L19 14l1.5-1.5L19 11l1.5-1.5z', 'Kim': 'M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.27 5.82 22 7 14.14 2 9.27l6.91-1.01L12 2z', 'Th·ªßy': 'M12 22C6.48 22 2 17.52 2 12S6.48 2 12 2s10 4.48 10 10-4.48 10-10 10zm0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm-1 12H9v-2h2v2zm2-2h-2V7h2v7zm1 2h2v-2h-2v2z'};
        const getElementIcon = (element) => `<svg class="element-icon" viewBox="0 0 24 24" fill="currentColor"><path d="${SVG_PATHS[element] || ''}"/></svg>`;
        
        const NOTE_TRANSLATIONS = {
          'Season': 'M√πa', 'Hidden Year': 'Can ·∫©n nƒÉm', 'Hidden Month': 'Can ·∫©n th√°ng', 'Hidden Day': 'Can ·∫©n ng√†y', 'Hidden Hour': 'Can ·∫©n gi·ªù',
          'Stem Month': 'Can th√°ng', 'Stem Hour': 'Can gi·ªù', 'Control Season': 'Kh·∫Øc m√πa', 'Weakening': 'Suy y·∫øu', 'Zheng Guan': 'Ch√≠nh Quan',
          'Zheng Yin': 'Ch√≠nh ·∫§n', 'Qi Sha': 'Th·∫•t S√°t', 'Pian Yin': 'Thi√™n ·∫§n', 'Zheng Cai': 'Ch√≠nh T√†i', 'Shang Guan': 'Th∆∞∆°ng Quan',
          'Jie Cai': 'Ki·∫øp T√†i', 'Shi Shen': 'Th·ª±c Th·∫ßn'
        };
        function translateNote(note) {
          return note.replace(
            /\b(Season|Hidden Year|Hidden Month|Hidden Day|Hidden Hour|Stem Month|Stem Hour|Control Season|Weakening|Zheng Guan|Zheng Yin|Qi Sha|Pian Yin|Zheng Cai|Shang Guan|Jie Cai|Shi Shen)\b/g,
            (_, key) => NOTE_TRANSLATIONS[key] || key
          );
        }

        // --- EXPLANATION CONTENT ---
        const M·ªÜNH_CH·ª¶_CONTENT = `<h3>M·ªánh Ch·ªß (Nh·∫≠t Ch·ªß) & S·ª©c M·∫°nh</h3><p>Trong B√°t T·ª±, <strong>M·ªánh Ch·ªß (Day Master)</strong> l√† Thi√™n Can ·ªü c·ªôt Ng√†y ‚Äì t∆∞·ª£ng tr∆∞ng cho b·∫£n th√¢n b·∫°n. S·ª©c m·∫°nh c·ªßa n√≥ (V∆∞·ª£ng/Nh∆∞·ª£c) l√† y·∫øu t·ªë c·ªët l√µi ƒë·ªÉ x√°c ƒë·ªãnh chi·∫øn l∆∞·ª£c c√¢n b·∫±ng Ng≈© H√†nh.</p><h3>C√°ch hi·ªÉu ƒëi·ªÉm s·ª©c m·∫°nh</h3><p>ƒêi·ªÉm s·ªë (v√≠ d·ª•: -66) ƒë∆∞·ª£c t√≠nh b·∫±ng c√°ch c·ªông/tr·ª´ c√°c y·∫øu t·ªë ·∫£nh h∆∞·ªüng ƒë·∫øn M·ªánh Ch·ªß:</p><ul><li><strong>ƒêi·ªÉm > 0 ‚Üí H∆∞·ªõng V∆∞·ª£ng:</strong> B·∫°n c√≥ n·ªôi l·ª±c t·ªët, t·ª± tin.</li><li><strong>ƒêi·ªÉm < 0 ‚Üí H∆∞·ªõng Nh∆∞·ª£c:</strong> B·∫°n c√≥ th·ªÉ c·∫ßn s·ª± h·ªó tr·ª£ t·ª´ c√°c y·∫øu t·ªë b√™n ngo√†i. V·ªõi ƒëi·ªÉm √¢m, M·ªánh Ch·ªß b·ªã c√°c y·∫øu t·ªë xung kh·∫Øc (v√≠ d·ª• M√πa sinh) l√†m suy y·∫øu.</li></ul><h3>·∫¢nh h∆∞·ªüng c·ªßa V∆∞·ª£ng/Nh∆∞·ª£c</h3><ul><li><strong>V∆∞·ª£ng:</strong> D·ªÖ thu h√∫t t√†i l·ªôc, nh∆∞ng c·∫ßn c√°c h√†nh kh·∫Øc ch·∫ø ƒë·ªÉ ƒë·∫°t c√¢n b·∫±ng.</li><li><strong>Nh∆∞·ª£c:</strong> C·∫ßn ƒë∆∞·ª£c h·ªó tr·ª£ b·ªüi c√°c h√†nh "t∆∞∆°ng sinh" (nu√¥i d∆∞·ª°ng) v√† "t∆∞∆°ng tr·ª£" (c√πng h√†nh). ƒê√¢y ch√≠nh l√† c√°c H·ª∑ D·ª•ng Th·∫ßn gi√∫p b·∫°n gia tƒÉng may m·∫Øn.</li></ul><h3>H∆∞·ªõng x·ª≠ l√Ω cho M·ªánh Nh∆∞·ª£c</h3><ul><li><strong>TƒÉng c∆∞·ªùng ·∫§n (Resource):</strong> Ch·ªçn c√°c ng√†nh/ho·∫°t ƒë·ªông thu·ªôc h√†nh t∆∞∆°ng sinh. V√≠ d·ª•: M·ªánh Kim y·∫øu n√™n ∆∞u ti√™n ng√†nh h√†nh Th·ªï (B·∫•t ƒë·ªông s·∫£n).</li><li><strong>TƒÉng c∆∞·ªùng B·∫°n ƒë·ªìng h√†nh (Companion):</strong> Ch·ªçn ng√†nh/m√¥i tr∆∞·ªùng c√πng h√†nh v·ªõi M·ªánh Ch·ªß. V√≠ d·ª•: M·ªánh Kim y·∫øu c√≥ th·ªÉ l√†m trong ng√†nh T√†i ch√≠nh (h√†nh Kim).</li></ul>`;
        const L√Å_S·ªê_B√ÅT_T·ª∞_CONTENT = `<h3>C√°ch ƒë·ªçc L√° S·ªë B√°t T·ª± (T·ª© Tr·ª•)</h3><p>M·ªói tr·ª• bao g·ªìm m·ªôt Thi√™n Can (nƒÉng l∆∞·ª£ng b·ªÅ m·∫∑t) v√† m·ªôt ƒê·ªãa Chi (nƒÉng l∆∞·ª£ng ·∫©n, con gi√°p), ƒë·∫°i di·ªán cho m·ªôt kh√≠a c·∫°nh v√† giai ƒëo·∫°n trong cu·ªôc ƒë·ªùi.</p><ul><li><strong>Tr·ª• NƒÉm:</strong> ƒê·∫°i di·ªán cho t·ªï ti√™n, b·ªëi c·∫£nh x√£ h·ªôi, v√† tu·ªïi thi·∫øu th·ªùi. S·ª± t∆∞∆°ng t√°c Can-Chi ·ªü ƒë√¢y cho th·∫•y m√¥i tr∆∞·ªùng ban ƒë·∫ßu c·ªßa b·∫°n.</li><li><strong>Tr·ª• Th√°ng:</strong> ƒê·∫°i di·ªán cho cha m·∫π, anh em v√† s·ª± nghi·ªáp giai ƒëo·∫°n ƒë·∫ßu. ƒê√¢y l√† tr·ª• c√≥ ·∫£nh h∆∞·ªüng l·ªõn nh·∫•t ƒë·∫øn s·ª©c m·∫°nh c·ªßa M·ªánh Ch·ªß.</li><li><strong>Tr·ª• Ng√†y:</strong> Thi√™n Can c·ªßa tr·ª• n√†y ch√≠nh l√† <strong>M·ªánh Ch·ªß (b·∫°n)</strong>. ƒê·ªãa chi c·ªßa tr·ª• n√†y l√† cung Phu Th√™, ƒë·∫°i di·ªán cho ng∆∞·ªùi b·∫°n ƒë·ªùi v√† gia ƒë√¨nh.</li><li><strong>Tr·ª• Gi·ªù:</strong> ƒê·∫°i di·ªán cho con c√°i, ho√†i b√£o, v√† cu·ªôc s·ªëng v·ªÅ sau.</li></ul><p>Vi·ªác ph√¢n t√≠ch s·ª± t∆∞∆°ng t√°c (sinh, kh·∫Øc) gi·ªØa c√°c Can, Chi trong T·ª© Tr·ª• gi√∫p hi·ªÉu r√µ h∆°n v·ªÅ c√°c ti·ªÅm nƒÉng v√† th√°ch th·ª©c trong cu·ªôc s·ªëng c·ªßa b·∫°n.</p>`;
        const ƒê·∫†I_V·∫¨N_CONTENT = `<h3>ƒê·∫°i V·∫≠n (Â§ßÈÅã) ‚Äì V·∫≠n 10 NƒÉm</h3><p>ƒê·∫°i V·∫≠n l√† chu·ªói c√°c giai ƒëo·∫°n 10 nƒÉm trong cu·ªôc ƒë·ªùi, m·ªói giai ƒëo·∫°n ch·ªãu ·∫£nh h∆∞·ªüng c·ªßa m·ªôt c·∫∑p Thi√™n Can - ƒê·ªãa Chi ri√™ng. Vi·ªác ph√¢n t√≠ch ƒê·∫°i V·∫≠n gi√∫p b·∫°n c√≥ c√°i nh√¨n d√†i h·∫°n v·ªÅ nh·ªØng thu·∫≠n l·ª£i v√† th√°ch th·ª©c.</p><h3>√ù nghƒ©a c·ªßa m·ªói ƒê·∫°i V·∫≠n</h3><p>Thi√™n Can v√† ƒê·ªãa Chi c·ªßa m·ªói ƒê·∫°i V·∫≠n s·∫Ω t∆∞∆°ng t√°c v·ªõi l√° s·ªë g·ªëc c·ªßa b·∫°n, t·∫°o ra c√°c giai ƒëo·∫°n th·ªãnh suy kh√°c nhau.</p><ul><li>Khi Thi√™n Can c·ªßa v·∫≠n l√† h√†nh b·∫°n c·∫ßn (H·ª∑ D·ª•ng Th·∫ßn), b·∫°n th∆∞·ªùng g·∫∑p nhi·ªÅu c∆° h·ªôi, may m·∫Øn v·ªÅ t√†i ch√≠nh, s·ª± nghi·ªáp.</li><li>Ng∆∞·ª£c l·∫°i, n·∫øu Thi√™n Can c·ªßa v·∫≠n l√† h√†nh k·ªµ, giai ƒëo·∫°n ƒë√≥ c√≥ th·ªÉ g·∫∑p nhi·ªÅu tr·∫Øc tr·ªü h∆°n.</li></ul><h3>C√°ch s·ª≠ d·ª•ng</h3><ul><li><strong>L·∫≠p k·∫ø ho·∫°ch d√†i h·∫°n:</strong> Bi·∫øt ƒë∆∞·ª£c v·∫≠n 30-40 tu·ªïi s·∫Ω nh∆∞ th·∫ø n√†o gi√∫p b·∫°n d·ª± ƒëo√°n v√† ch·ªß ƒë·ªông chu·∫©n b·ªã cho s·ª± nghi·ªáp, t√†i ch√≠nh.</li><li><strong>Ch·ªçn th·ªùi ƒëi·ªÉm:</strong> Xem c√°c ƒê·∫°i V·∫≠n s·∫Øp t·ªõi ƒë·ªÉ quy·∫øt ƒë·ªãnh khi n√†o n√™n th·ª±c hi·ªán c√°c d·ª± √°n l·ªõn, ƒë·∫ßu t∆∞ ho·∫∑c thay ƒë·ªïi c√¥ng vi·ªác.</li><li><strong>K·∫øt h·ª£p v·ªõi V·∫≠n H·∫°n NƒÉm:</strong> So s√°nh ‚Äúƒê·∫°i V·∫≠n‚Äù (xu h∆∞·ªõng 10 nƒÉm) v·ªõi ‚ÄúV·∫≠n H·∫°n NƒÉm‚Äù (s·ª± ki·ªán h√†ng nƒÉm) ƒë·ªÉ c√≥ quy·∫øt ƒë·ªãnh t·ªëi ∆∞u nh·∫•t.</li></ul>`;
        const B√ÅT_TR·∫†CH_CONTENT = `<h3>Gi·∫£i Th√≠ch C√°c H∆∞·ªõng B√°t Tr·∫°ch</h3><p>B√°t tr·∫°ch l√† m·ªôt ph∆∞∆°ng ph√°p Phong Th·ªßy gi√∫p x√°c ƒë·ªãnh c√°c h∆∞·ªõng nƒÉng l∆∞·ª£ng t·ªët (c√°t) v√† x·∫•u (hung) d·ª±a tr√™n Cung M·ªánh (Life Gua) c·ªßa m·ªói ng∆∞·ªùi. Vi·ªác ·ª©ng d·ª•ng ƒë√∫ng c√°c h∆∞·ªõng n√†y c√≥ th·ªÉ gi√∫p c·∫£i thi·ªán v·∫≠n may v·ªÅ t√†i l·ªôc, s·ª©c kh·ªèe, v√† c√°c m·ªëi quan h·ªá.</p><h3>H∆∞·ªõng Thu·∫≠n (Auspicious)</h3><ul><li><strong>Sinh Kh√≠ (T√†i L·ªôc):</strong> T·ªët nh·∫•t cho t√†i l·ªôc, danh ti·∫øng, thƒÉng ti·∫øn. N√™n ƒë·∫∑t b√†n l√†m vi·ªác, c·ª≠a ch√≠nh, k√©t s·∫Øt ·ªü h∆∞·ªõng n√†y.</li><li><strong>Thi√™n Y (S·ª©c Kh·ªèe):</strong> T·ªët nh·∫•t cho s·ª©c kh·ªèe, tr∆∞·ªùng th·ªç. N√™n ƒë·∫∑t ph√≤ng ng·ªß, gi∆∞·ªùng ng·ªß ·ªü h∆∞·ªõng n√†y.</li><li><strong>Di√™n Ni√™n (Quan H·ªá):</strong> T·ªët cho t√¨nh c·∫£m gia ƒë√¨nh, c√°c m·ªëi quan h·ªá x√£ h·ªôi. N√™n ƒë·∫∑t ph√≤ng kh√°ch, b√†n ƒÉn ·ªü h∆∞·ªõng n√†y.</li><li><strong>Ph·ª•c V·ªã (·ªîn ƒê·ªãnh):</strong> Mang l·∫°i s·ª± b√¨nh y√™n, ·ªïn ƒë·ªãnh tinh th·∫ßn, may m·∫Øn trong h·ªçc t·∫≠p, thi c·ª≠. N√™n ƒë·∫∑t b√†n h·ªçc, b√†n th·ªù ·ªü h∆∞·ªõng n√†y.</li></ul><h3>H∆∞·ªõng Hung (Inauspicious)</h3><ul><li><strong>H·ªça H·∫°i:</strong> G√¢y th·ªã phi, tranh c√£i. Tr√°nh ƒë·∫∑t c·ª≠a ch√≠nh, ph√≤ng l√†m vi·ªác.</li><li><strong>Ng≈© Qu·ª∑:</strong> G√¢y b·ªánh t·∫≠t, m·∫•t m√°t t√†i s·∫£n. Tr√°nh ƒë·∫∑t ph√≤ng ng·ªß, b·∫øp.</li><li><strong>L·ª•c S√°t:</strong> G√¢y tai ti·∫øng, ki·ªán t·ª•ng. Tr√°nh ƒë·∫∑t c√°c khu v·ª±c quan tr·ªçng li√™n quan ƒë·∫øn c√¥ng vi·ªác, h·ª£p ƒë·ªìng.</li><li><strong>Tuy·ªát M·ªánh:</strong> H∆∞·ªõng x·∫•u nh·∫•t, g√¢y ph√° s·∫£n, tai h·ªça. Tuy·ªát ƒë·ªëi tr√°nh c√°c khu v·ª±c quan tr·ªçng nh∆∞ c·ª≠a ch√≠nh, ph√≤ng ng·ªß, b·∫øp.</li></ul><p><strong>L∆∞u √Ω:</strong> N·∫øu kh√¥ng th·ªÉ tr√°nh c√°c h∆∞·ªõng x·∫•u, c√≥ th·ªÉ d√πng c√°c v·∫≠t ph·∫©m phong th·ªßy nh∆∞ g∆∞∆°ng b√°t qu√°i, c√¢y xanh, t·ª≥ h∆∞u ƒë·ªÉ h√≥a gi·∫£i.</p>`;


        // --- COMPONENTS ---

        function ElementIcon({ element }) {
            const style = STYLE_CLASSES[element] || {};
            if (!style.text) return null;
            return <span className={`inline-flex items-center ${style.text}`} dangerouslySetInnerHTML={{ __html: getElementIcon(element) }} />;
        }
        
        function Pillar({ pillar, label, className = '' }) {
            if (!pillar || !pillar.stem || !pillar.branch) return <div className={`pillar-card flex-1 p-4 rounded-lg bg-gray-100 flex items-center justify-center ${className}`}><span className="text-gray-400">Kh√¥ng r√µ</span></div>;
            const stemElementVi = TRANSLATIONS.elements[pillar.stem.element];
            const branchElementVi = TRANSLATIONS.elements[pillar.branch.element];
            const stemStyle = STYLE_CLASSES[stemElementVi] || {};
            const branchStyle = STYLE_CLASSES[branchElementVi] || {};
            const tenGod = pillar.stem.tenGod ? TRANSLATIONS.tenGods[pillar.stem.tenGod.name] : null;

            return (
                <div className={`pillar-card flex-1 p-4 rounded-lg bg-gray-50 ${className}`}>
                    {label && <div className="text-sm font-semibold text-gray-500 mb-2">{label}</div>}
                    <div className={`stem ${stemStyle.text || 'text-gray-700'}`}><ElementIcon element={stemElementVi} />{TRANSLATIONS.stems[pillar.stem.name] || pillar.stem.name}</div>
                    <div className={`branch ${branchStyle.text || 'text-gray-700'} mt-1`}>{TRANSLATIONS.branches[pillar.branch.name] || pillar.branch.name} ({TRANSLATIONS.animals[pillar.branch.animal] || pillar.branch.animal})</div>
                    {tenGod && <div className="mt-2 text-xs font-semibold text-white bg-gray-400 rounded-full px-2 py-0.5 inline-block">{tenGod}</div>}
                </div>
            );
        }

        function Results({ data, onOpenModal }) {
            if (!data) return null;
            const { pillars, dayMaster, strength, favorableElements, industries, luckPillars, annualAnalysis, fiveFactors, eightMansions, symbolicStars, dayMasterStrengthDetails, luckPeriodsData } = data;
            
            return (
                <div id="results" className="mt-8 space-y-6 animate-fade-in">
                    {/* Primary Analysis */}
                    <PillarSection pillars={pillars} onOpenModal={onOpenModal}/>
                    <DayMasterSection dayMaster={dayMaster} strength={strength} dayMasterStrengthDetails={dayMasterStrengthDetails} onOpenModal={onOpenModal} />
                    {luckPillars && <LuckPillarsSection luckPillars={luckPillars} birthYear={data.birthYear} onOpenModal={onOpenModal} />}
                    {annualAnalysis && <AnnualAnalysisSection annualAnalysis={annualAnalysis} />}
                    <InvestmentSuggestionSection favorableElements={favorableElements} industries={industries} />
                    
                    {/* Favorable Periods Section */}
                    {luckPeriodsData && <FavorablePeriodsSection periods={luckPeriodsData} />}

                    {/* Supplementary Analysis */}
                    <div className="card">
                         <div className="flex items-center mb-4">
                            <h2 className="text-xl font-bold text-gray-800">Ph√¢n T√≠ch B·ªï Sung</h2>
                        </div>
                        <div className="space-y-6">
                            {fiveFactors && <FiveElementChart fiveFactors={fiveFactors} />}
                            {symbolicStars && <SymbolicStarsSection stars={symbolicStars} />}
                            {eightMansions && <EightMansionsSection mansions={eightMansions} onOpenModal={onOpenModal}/>}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Sub-components for better organization ---
        const PillarSection = ({ pillars, onOpenModal }) => (
             <div className="card">
                <div className="flex items-center mb-4">
                    <h2 className="text-xl font-bold text-gray-800">L√° S·ªë B√°t T·ª± (T·ª© Tr·ª•)</h2>
                    <button onClick={() => onOpenModal('Gi·∫£i Th√≠ch: L√° S·ªë B√°t T·ª±', L√Å_S·ªê_B√ÅT_T·ª∞_CONTENT)} className="info-button">?</button>
                </div>
                <div className="flex flex-col md:flex-row gap-4">
                    <Pillar pillar={pillars.year} label="Tr·ª• NƒÉm" />
                    <Pillar pillar={pillars.month} label="Tr·ª• Th√°ng" />
                    <Pillar pillar={pillars.day} label="Tr·ª• Ng√†y" />
                    <Pillar pillar={pillars.time} label="Tr·ª• Gi·ªù" />
                </div>
            </div>
        );

        const DayMasterSection = ({dayMaster, strength, dayMasterStrengthDetails, onOpenModal}) => {
            const [detailsVisible, setDetailsVisible] = useState(false);
            const dayMasterElementVi = TRANSLATIONS.elements[dayMaster.element];
            const dayMasterStyle = STYLE_CLASSES[dayMasterElementVi] || {};
            
            return (
                <div className="card">
                    <div className="flex items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Ph√¢n T√≠ch M·ªánh Ch·ªß</h2>
                        <button onClick={() => onOpenModal('Gi·∫£i Th√≠ch: M·ªánh Ch·ªß & S·ª©c M·∫°nh', M·ªÜNH_CH·ª¶_CONTENT)} className="info-button">?</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg">
                        <div className={`p-4 rounded-lg ${dayMasterStyle.bg || STYLE_CLASSES['Th·ªßy'].bg}`}><span className="font-semibold">M·ªánh Ch·ªß (Nh·∫≠t Ch·ªß):</span><span className={`font-bold ${dayMasterStyle.text || 'text-gray-700'} ml-2`}><ElementIcon element={dayMasterElementVi} />{TRANSLATIONS.stems[dayMaster.name] || dayMaster.name} ({dayMasterElementVi})</span></div>
                        <div className={`p-4 rounded-lg ${strength === 'V∆∞·ª£ng' ? STYLE_CLASSES['M·ªôc'].bg : STYLE_CLASSES['H·ªèa'].bg}`}><span className="font-semibold">S·ª©c m·∫°nh:</span><span className={`font-bold ml-2 ${strength === 'V∆∞·ª£ng' ? STYLE_CLASSES['M·ªôc'].text : STYLE_CLASSES['H·ªèa'].text}`}>{strength}</span> <button onClick={() => setDetailsVisible(!detailsVisible)} className="ml-2 text-sm text-blue-600">(chi ti·∫øt)</button></div>
                    </div>
                    {detailsVisible && dayMasterStrengthDetails && (
                        <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                            <h3 className="font-semibold mb-2">Y·∫øu t·ªë ƒë√≥ng g√≥p v√†o s·ª©c m·∫°nh:</h3>
                            {dayMasterStrengthDetails.notes && Array.isArray(dayMasterStrengthDetails.notes) ? (
                                <ul className="text-sm space-y-1">
                                    {dayMasterStrengthDetails.notes.map((note, i) => (
                                        <li key={i} className="p-1 rounded bg-gray-100"> ‚Ä¢ {translateNote(note)}</li>
                                    ))}
                                    <li className="flex justify-between p-1 border-t font-bold"><span>T·ªïng ƒëi·ªÉm:</span> <span>{dayMasterStrengthDetails.score}</span></li>
                                </ul>
                            ) : (
                                <p className="text-sm text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt v·ªÅ c√°c y·∫øu t·ªë ƒë√≥ng g√≥p.</p>
                            )}
                        </div>
                    )}
                </div>
            )
        };
        
        const LuckPillarsSection = ({luckPillars, birthYear, onOpenModal}) => {
            const currentYear = new Date().getFullYear();
            const currentAge = currentYear - birthYear;
            return (
                 <div className="card">
                     <div className="flex items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Ph√¢n T√≠ch ƒê·∫°i V·∫≠n (10 NƒÉm)</h2>
                        <button onClick={() => onOpenModal('Gi·∫£i Th√≠ch: ƒê·∫°i V·∫≠n', ƒê·∫†I_V·∫¨N_CONTENT)} className="info-button">?</button>
                    </div>
                    <div className="luck-pillar-grid">
                        {luckPillars.pillars.map(p => (
                            <div key={p.number} className={`p-3 rounded-lg border ${currentAge >= p.ageStart && currentAge < (p.ageStart + 10) ? 'bg-indigo-50 border-indigo-400' : 'bg-white'}`}>
                                <div className="font-bold text-gray-700">{p.ageStart} tu·ªïi</div>
                                <div className="text-xs text-gray-500">{p.yearStart} - {p.yearEnd}</div>
                                <Pillar pillar={{ stem: p.heavenlyStem, branch: p.earthlyBranch }} className="mt-2 shadow-none border-0 p-2" />
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const AnnualAnalysisSection = ({ annualAnalysis }) => {
            const currentYear = new Date().getFullYear();
            if (!annualAnalysis || !annualAnalysis.annualPillarContext) return null;
            return (
                 <div className="card">
                    <h2 className="text-xl font-bold text-gray-800 mb-2">Ph√¢n T√≠ch V·∫≠n H·∫°n NƒÉm {currentYear}</h2>
                    <div className="flex items-center gap-4 p-2 rounded-lg bg-gray-50">
                        <Pillar pillar={annualAnalysis.annualPillarContext.pillar} label={`NƒÉm ${currentYear}`} className="shadow-none border-0 p-2" />
                        <div className="flex-1">
                            <h3 className="font-semibold text-gray-700">T∆∞∆°ng t√°c v·ªõi L√° s·ªë g·ªëc:</h3>
                            {annualAnalysis.interactions.length > 0 ? (
                                <div className="mt-1 flex flex-wrap gap-2">
                                    {annualAnalysis.interactions.map((int, i) => {
                                        const [{ elementChar: branch1 }, { elementChar: branch2 }] = int.participants;
                                        const tagColor = ['clash','harm','punishment','destruction'].includes(int.type) ? 'bad' : 'good';
                                        const key = `${int.type}-${branch1}-${branch2}-${i}`;

                                        return (
                                            <span key={key} className={`interaction-tag ${STYLE_CLASSES[tagColor].tag}`}>
                                                {TRANSLATIONS.interactions[int.type]}: {TRANSLATIONS.branches[branch1]}‚Äì{TRANSLATIONS.branches[branch2]}
                                            </span>
                                        );
                                    })}
                                </div>
                            ) : <p className="text-sm text-gray-500">Kh√¥ng c√≥ t∆∞∆°ng t√°c Xung/H·ª£p/H·∫°i/H√¨nh ch√≠nh.</p>}
                        </div>
                    </div>
                </div>
            );
        };
        
        const InvestmentSuggestionSection = ({ favorableElements, industries }) => (
             <div className="card">
                 <h2 className="text-xl font-bold text-gray-800 mb-2">Ng√†nh ƒê·∫ßu T∆∞ G·ª£i √ù (D·ª±a tr√™n H·ª∑ D·ª•ng Th·∫ßn)</h2>
                 <p className="text-gray-600 mb-4">C√°c ng√†nh thu·ªôc h√†nh v∆∞·ª£ng s·∫Ω mang l·∫°i nhi·ªÅu thu·∫≠n l·ª£i h∆°n cho vi·ªác ƒë·∫ßu t∆∞ v√† ph√°t tri·ªÉn.</p>
                 <div className="space-y-4">
                    {favorableElements.map(element => (
                        <div key={element} className="p-4 border rounded-lg">
                            <h3 className={`text-lg font-bold ${STYLE_CLASSES[element]?.text || 'text-gray-700'} mb-2`}><ElementIcon element={element} />H√†nh {element}</h3>
                            <ul className="space-y-2">{industries[element]?.map((industry, index) => (<li key={`${element}-${industry.name}-${index}`} className="p-3 bg-gray-50 rounded-md"><p className="font-semibold text-gray-800">{industry.name}</p><p className="text-sm text-gray-500">{industry.desc}</p></li>))}</ul>
                        </div>
                    ))}
                 </div>
            </div>
        );

        const FiveElementChart = ({ fiveFactors }) => {
            const totalScore = Object.values(fiveFactors).reduce((sum, v) => sum + v, 0);
            const elements = Object.entries(fiveFactors).map(([key, score]) => ({ name: TRANSLATIONS.elements[key], score, percentage: totalScore > 0 ? (score / totalScore) * 100 : 0 }));
            const strongest = elements.reduce((max, el) => el.score > max.score ? el : max, {score: -Infinity});
            const weakest = elements.reduce((min, el) => el.score < min.score ? el : min, {score: Infinity});

            return (
                <div>
                    <h3 className="text-lg font-semibold text-gray-700 mb-2">Ph√¢n B·ªï Ng≈© H√†nh</h3>
                    <div className="space-y-2">
                    {elements.map(el => (
                        <div key={el.name} className="flex items-center">
                            <span className="w-12 font-medium text-sm">{el.name}</span>
                            <div className="flex-1 bg-gray-200 rounded-full h-5 mx-2">
                                <div className={`bar-chart-bar ${STYLE_CLASSES[el.name]?.chart || ''}`} style={{width: `${el.percentage}%`}}></div>
                            </div>
                            <span className="w-12 text-right font-semibold text-sm">{el.score}</span>
                        </div>
                    ))}
                    </div>
                     <div className="text-xs text-center mt-2"><strong>V∆∞·ª£ng nh·∫•t:</strong> {strongest.name} | <strong>Suy nh·∫•t:</strong> {weakest.name}</div>
                </div>
            );
        };

        const SymbolicStarsSection = ({ stars }) => (
            <div>
                <h3 className="text-lg font-semibold text-gray-700 mb-2">Th·∫ßn S√°t ƒê·∫∑c Bi·ªát</h3>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                    <div><span role="img" aria-label="Nobleman">ü§ù</span><p className="font-semibold">Qu√Ω Nh√¢n</p><p className="text-gray-600">{Array.isArray(stars.nobleman) && stars.nobleman.length ? stars.nobleman.map(b => TRANSLATIONS.branches[b]).join(', ') : 'Kh√¥ng c√≥'}</p></div>
                    <div><span role="img" aria-label="Intelligence">üí°</span><p className="font-semibold">VƒÉn X∆∞∆°ng</p><p className="text-gray-600">{stars.intelligence ? TRANSLATIONS.branches[stars.intelligence] : 'Kh√¥ng c√≥'}</p></div>
                    <div><span role="img" aria-label="Sky Horse">üêé</span><p className="font-semibold">Thi√™n M√£</p><p className="text-gray-600">{stars.skyHorse ? TRANSLATIONS.branches[stars.skyHorse] : 'Kh√¥ng c√≥'}</p></div>
                    <div><span role="img" aria-label="Peach Blossom">üå∏</span><p className="font-semibold">ƒê√†o Hoa</p><p className="text-gray-600">{stars.peachBlossom ? TRANSLATIONS.branches[stars.peachBlossom] : 'Kh√¥ng c√≥'}</p></div>
                </div>
            </div>
        );

        const EightMansionsSection = ({ mansions, onOpenModal }) => {
            if (!mansions || !mansions.directions) return null;
            
            return (
                <div>
                    <div className="flex items-center mb-2">
                        <h3 className="text-lg font-semibold text-gray-700">B√°t Tr·∫°ch Phong Th·ªßy</h3>
                        <button onClick={() => onOpenModal('Gi·∫£i Th√≠ch: B√°t Tr·∫°ch', B√ÅT_TR·∫†CH_CONTENT)} className="info-button">?</button>
                    </div>
                     <p className="text-sm text-gray-600 mb-2">Cung M·ªánh c·ªßa b·∫°n l√† <strong>{mansions.lifeGuaTrigram || "‚Äî"}{mansions.lifeGuaElement ? ` (${TRANSLATIONS.elements[mansions.lifeGuaElement]})` : ""}</strong>. C√°c h∆∞·ªõng t·ªët v√† x·∫•u:</p>
                     <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                        {Object.entries(mansions.directions).map(([key, value]) => {
                            const isAuspicious = value.type === 'Auspicious';
                            return (
                                <div key={key} className={`p-2 rounded-md ${isAuspicious ? 'bg-green-50' : 'bg-red-50'}`}>
                                    <p className={`font-bold ${isAuspicious ? 'text-green-800' : 'text-red-800'}`}>{TRANSLATIONS.directions[value.direction]}: {TRANSLATIONS.eightMansions[key] || key}</p>
                                    <p className={`${isAuspicious ? 'text-green-700' : 'text-red-700'}`}>{value.description}</p>
                                </div>
                            )
                        })}
                     </div>
                </div>
            )
        };
        
        const FavorablePeriodsSection = ({ periods }) => (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="card">
                    <h2 className="text-xl font-bold mb-4 text-green-700">Giai ƒêo·∫°n Thu·∫≠n T√†i</h2>
                    <div className="space-y-1 text-sm">
                    {periods.finance.length > 0 ? (
                        periods.finance.map(p => (
                            <p key={p.key} className="p-1">T·ª´ <strong>{p.age}</strong> tu·ªïi ({p.years}) ‚Äî Thi√™n Can: <strong>{p.tenGodName}</strong></p>
                        ))
                    ) : (
                        <p className="text-gray-500">Kh√¥ng c√≥ giai ƒëo·∫°n h·ªó tr·ª£ t√†i ch√≠nh r√µ r√†ng trong c√°c ƒê·∫°i V·∫≠n s·∫Øp t·ªõi.</p>
                    )}
                    </div>
                </div>
                <div className="card">
                    <h2 className="text-xl font-bold mb-4 text-blue-700">Giai ƒêo·∫°n Thu·∫≠n S·ª©c Kh·ªèe & H·ªçc V·∫•n</h2>
                     <div className="space-y-1 text-sm">
                    {periods.health.length > 0 ? (
                        periods.health.map(p => (
                             <p key={p.key} className="p-1">T·ª´ <strong>{p.age}</strong> tu·ªïi ({p.years}) ‚Äî Thi√™n Can: <strong>{p.tenGodName}</strong></p>
                        ))
                    ) : (
                        <p className="text-gray-500">Kh√¥ng c√≥ giai ƒëo·∫°n h·ªó tr·ª£ s·ª©c kh·ªèe/h·ªçc v·∫•n r√µ r√†ng trong c√°c ƒê·∫°i V·∫≠n s·∫Øp t·ªõi.</p>
                    )}
                    </div>
                </div>
            </div>
        );

        function InfoModal({ isOpen, onClose, title, content }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 relative modal-content" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">{title}</h2>
                        <div className="text-gray-700 space-y-2" dangerouslySetInnerHTML={{ __html: content }}></div>
                    </div>
                </div>
            );
        }

        function App() {
            const [birthDate, setBirthDate] = useState('1990-05-15');
            const [birthTime, setBirthTime] = useState('12:30');
            const [gender, setGender] = useState('male');
            const [timeZone, setTimeZone] = useState('Asia/Ho_Chi_Minh');
            const [isTimeKnown, setIsTimeKnown] = useState(true);
            const [isLibraryReady, setIsLibraryReady] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState(null);

            const openModal = (title, content) => {
                setModalContent({ title, content });
                setIsModalOpen(true);
            };

            const closeModal = () => setIsModalOpen(false);
            
            const handleCalculate = () => {
                if (!isLibraryReady) { setError('Th∆∞ vi·ªán t√≠nh to√°n ch∆∞a s·∫µn s√†ng.'); return; }
                
                setError('');
                setIsLoading(true);

                if (!birthDate) { setError('Vui l√≤ng nh·∫≠p ng√†y sinh.'); setIsLoading(false); return; }
                if (isTimeKnown && !birthTime) { setError('Vui l√≤ng nh·∫≠p gi·ªù sinh ho·∫∑c b·ªè tick "Bi·∫øt gi·ªù sinh".'); setIsLoading(false); return; }
                
                try {
                    const { BaziCalculator, dateFnsTz } = window;
                    const birthDateTime = isTimeKnown ? dateFnsTz.toDate(`${birthDate}T${birthTime}`, { timeZone }) : dateFnsTz.toDate(birthDate, { timeZone });
                    const calculator = new BaziCalculator(birthDateTime, gender, timeZone, isTimeKnown);
                    
                    const analysis = calculator.getCompleteAnalysis();
                    if (!analysis || !analysis.basicAnalysis || !analysis.basicAnalysis.dayMaster || !analysis.detailedPillars) {
                         throw new Error("Kh√¥ng th·ªÉ ph√¢n t√≠ch l√° s·ªë. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin ƒë·∫ßu v√†o.");
                    }

                    const dayMaster = analysis.basicAnalysis.dayMaster;
                    const strengthRaw = analysis.basicAnalysis.dayMasterStrength.strength;
                    const dayMasterElementVi = TRANSLATIONS.elements[dayMaster.element];
                    const strength = ['Strong', 'Extremely Strong', 'Vibrant'].includes(strengthRaw) ? 'V∆∞·ª£ng' : 'Nh∆∞·ª£c';

                    let favorableElements = [];
                    if (strength === 'V∆∞·ª£ng') {
                        favorableElements.push(WUXING_RELATIONS.controls[dayMasterElementVi]);
                        favorableElements.push(WUXING_RELATIONS.produces[dayMasterElementVi]);
                    } else { 
                        const producingElement = Object.keys(WUXING_RELATIONS.produces).find(key => WUXING_RELATIONS.produces[key] === dayMasterElementVi);
                        favorableElements.push(producingElement);
                        favorableElements.push(dayMasterElementVi);
                    }
                    favorableElements = [...new Set(favorableElements)].filter(Boolean);

                    const recommendedIndustries = {};
                    favorableElements.forEach(el => { recommendedIndustries[el] = INDUSTRY_MAP[el]; });
                    
                    const today = new Date();
                    const annualAnalysis = calculator.getAnalysisForDate(today, timeZone, { type: 'personalized' });
                    
                    const detailedPillars = analysis.detailedPillars;
                    const mappedPillars = {
                        year: { stem: detailedPillars.year.heavenlyStem, branch: detailedPillars.year.earthlyBranch },
                        month: { stem: detailedPillars.month.heavenlyStem, branch: detailedPillars.month.earthlyBranch },
                        day: { stem: detailedPillars.day.heavenlyStem, branch: detailedPillars.day.earthlyBranch },
                        time: detailedPillars.hour ? { stem: detailedPillars.hour.heavenlyStem, branch: detailedPillars.hour.earthlyBranch } : null
                    };
                    
                    const luckPeriodsData = { finance: [], health: [] };
                    if (analysis.luckPillars) {
                        const financeGods = ['Direct Wealth', 'Indirect Wealth', 'Seven Killings', 'Direct Officer'];
                        const healthGods = ['Direct Resource', 'Indirect Resource'];

                        analysis.luckPillars.pillars.forEach(p => {
                            const tenGodName = p.heavenlyStem.tenGod?.name;
                            if (tenGodName) {
                                const periodInfo = { age: p.ageStart, years: `${p.yearStart}-${p.yearEnd}`, tenGodName: TRANSLATIONS.tenGods[tenGodName] || tenGodName, key: p.number };
                                if (financeGods.includes(tenGodName)) { luckPeriodsData.finance.push(periodInfo); }
                                if (healthGods.includes(tenGodName)) { luckPeriodsData.health.push(periodInfo); }
                            }
                        });
                    }

                    const rawEightMansions = analysis.basicAnalysis.eightMansions;
                    let transformedEightMansions = null;
                    if (rawEightMansions) {
                        const trigramMap = { 'East': 'ƒê√¥ng', 'West': 'T√¢y', 'South': 'Nam', 'North': 'B·∫Øc', 'Northeast': 'ƒê√¥ng B·∫Øc', 'Southeast': 'ƒê√¥ng Nam', 'Southwest': 'T√¢y Nam', 'Northwest': 'T√¢y B·∫Øc'};
                        const directions = {};
                        if(rawEightMansions.lucky) {
                            Object.entries(rawEightMansions.lucky).forEach(([kind, dir]) => {
                                directions[kind] = { type: 'Auspicious', direction: dir, description: TRANSLATIONS.eightMansions[kind] || kind };
                            });
                        }
                        if(rawEightMansions.unlucky) {
                            Object.entries(rawEightMansions.unlucky).forEach(([kind, dir]) => {
                                directions[kind] = { type: 'Inauspicious', direction: dir, description: TRANSLATIONS.eightMansions[kind] || kind };
                            });
                        }
                        transformedEightMansions = {
                             lifeGuaTrigram: trigramMap[rawEightMansions.group] || rawEightMansions.group,
                             lifeGuaElement: rawEightMansions.elementName,
                             directions
                        }
                    }

                    setResults({
                        birthYear: birthDateTime.getFullYear(),
                        pillars: mappedPillars,
                        dayMaster: dayMaster,
                        strength,
                        favorableElements,
                        industries: recommendedIndustries,
                        luckPillars: analysis.luckPillars,
                        annualAnalysis,
                        fiveFactors: analysis.basicAnalysis.fiveFactors,
                        eightMansions: transformedEightMansions,
                        symbolicStars: analysis.basicAnalysis.symbolicStars,
                        dayMasterStrengthDetails: analysis.basicAnalysis.dayMasterStrength,
                        luckPeriodsData
                    });

                } catch (e) {
                    console.error('‚ùå calculation error', e);
                    setError(e.message || 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin v√† m√∫i gi·ªù (VD: Asia/Ho_Chi_Minh).');
                } finally {
                    setIsLoading(false);
                }
            };
            
            useEffect(() => {
                const setLibraryReady = () => setIsLibraryReady(true);
                window.addEventListener('bazi-library-ready', setLibraryReady);
                if (window.BaziCalculator && window.dateFnsTz) { setLibraryReady(); }
                return () => window.removeEventListener('bazi-library-ready', setLibraryReady);
            }, []);

            const getButtonText = () => {
                if (!isLibraryReady) return 'ƒêang t·∫£i th∆∞ vi·ªán...';
                if (isLoading) return 'ƒêang ph√¢n t√≠ch...';
                return 'Xem Ph√¢n T√≠ch';
            }

            return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8">
                    <div className="max-w-4xl mx-auto">
                        <header className="text-center mb-8">
                             <h1 className="text-3xl sm:text-4xl font-bold text-gray-800">B√°t T·ª± & G·ª£i √ù Ng√†nh ƒê·∫ßu T∆∞</h1>
                             <p className="mt-2 text-lg text-gray-600">Kh√°m ph√° c√°c ng√†nh ngh·ªÅ ti·ªÅm nƒÉng v√† ph√¢n t√≠ch v·∫≠n h·∫°n c·ªßa b·∫°n.</p>
                        </header>
                        
                        <div className="card">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                <div><label htmlFor="birthDate" className="block text-sm font-medium text-gray-700 mb-1">Ng√†y Sinh</label><input type="date" id="birthDate" value={birthDate} onChange={e => setBirthDate(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>
                                <div><label htmlFor="birthTime" className="block text-sm font-medium text-gray-700 mb-1">Gi·ªù Sinh</label><input type="time" id="birthTime" value={birthTime} onChange={e => setBirthTime(e.target.value)} disabled={!isTimeKnown} className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100" /></div>
                                <div><label htmlFor="timeZone" className="block text-sm font-medium text-gray-700 mb-1">M√∫i Gi·ªù</label><input type="text" id="timeZone" value={timeZone} onChange={e => setTimeZone(e.target.value)} placeholder="VD: Asia/Ho_Chi_Minh" className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>
                                <div><label htmlFor="gender" className="block text-sm font-medium text-gray-700 mb-1">Gi·ªõi T√≠nh</label><select id="gender" value={gender} onChange={e => setGender(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="male">Nam</option><option value="female">N·ªØ</option></select></div>
                            </div>
                            <div className="mt-4 flex justify-between items-center">
                                <label className="flex items-center"><input type="checkbox" checked={isTimeKnown} onChange={e => setIsTimeKnown(e.target.checked)} className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" /><span className="ml-2 text-sm text-gray-600">Bi·∫øt gi·ªù sinh</span></label>
                                <button onClick={handleCalculate} disabled={isLoading || !isLibraryReady} className="bg-indigo-600 text-white font-bold py-2 px-6 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 disabled:bg-indigo-400 disabled:cursor-not-allowed">{getButtonText()}</button>
                            </div>
                            {error && <p className="mt-2 text-center text-red-600">{error}</p>}
                        </div>

                        {!results && !isLoading && !error && <div className="text-center p-8 text-gray-500">Nh·∫≠p th√¥ng tin c·ªßa b·∫°n v√† nh·∫•n "Xem Ph√¢n T√≠ch" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>}
                        
                        {isLoading && <div className="text-center p-8 text-gray-500">ƒêang ph√¢n t√≠ch...</div>}
                        {results && <Results data={results} onOpenModal={openModal} />}

                        <InfoModal isOpen={isModalOpen} onClose={closeModal} title={modalContent?.title} content={modalContent?.content} />


                        <footer className="text-center mt-8 text-xs text-gray-500">
                           <p>S·ª≠ d·ª•ng th∆∞ vi·ªán @aharris02/bazi-calculator-by-alvamind & date-fns-tz.</p>
                           <p className="mt-2"><strong>Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám:</strong> ·ª®ng d·ª•ng n√†y ƒë∆∞·ª£c t·∫°o ra cho m·ª•c ƒë√≠ch tham kh·∫£o v√† gi√°o d·ª•c. Th√¥ng tin cung c·∫•p kh√¥ng ƒë∆∞·ª£c coi l√† l·ªùi khuy√™n ƒë·∫ßu t∆∞ chuy√™n nghi·ªáp. Lu√¥n tham kh·∫£o √Ω ki·∫øn chuy√™n gia t√†i ch√≠nh tr∆∞·ªõc khi ra quy·∫øt ƒë·ªãnh.</p>
                        </footer>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
